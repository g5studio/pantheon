---
alwaysApply: true
---

# 障礙排除指南

此規則定義了 AI 在執行任務時遇到常見問題的處理方式。當 AI 遇到問題時，應優先查詢此指南是否有對應的用例可參考。

## 適用場景

此規則適用於**所有** AI 執行任務時遇到問題的情境。AI 在遇到錯誤或異常時，應優先查詢此指南是否有對應的解決方案。

## 核心原則

**CRITICAL**: 當 AI 遇到問題時，**必須**：

1. **優先查詢此指南**：檢查是否有對應的用例和解決方案
2. **按照指南執行**：如果找到對應的用例，按照指南中的方式處理，**無需詢問用戶**
3. **記錄處理方式**：在 chat 中簡要說明採用的處理方式（可選，但建議記錄）

## 障礙排除用例

### 用例 1：Sandbox 權限不足導致執行失敗

**問題描述**：
- 執行腳本或命令時，因為 Cursor 的 sandbox 環境限制而導致執行失敗
- 常見錯誤訊息：權限被拒絕、無法執行系統調用、osascript 無法執行等
- 常見場景：執行系統通知腳本、執行需要系統權限的命令等

**判斷標準**：
- 錯誤訊息包含權限相關關鍵字（permission、sandbox、access denied 等）
- 腳本或命令本身沒有問題，但因為環境限制而失敗
- 涉及系統調用（如 macOS 的 `osascript`、檔案系統操作等）

**處理方式**：
- **立即採用**：使用 `required_permissions: ["all"]` 重新執行相同的命令
- **無需詢問**：此處理方式已在此指南中明確定義，AI 可以直接執行
- **重新執行**：使用相同的命令，但加上 `required_permissions: ["all"]` 參數

**執行範例**：

**錯誤情況**：
```bash
node .cursor/scripts/notification/notify-cursor-rules-failed.mjs "pantheon" "推送完成"
# 錯誤：權限被拒絕或 osascript 無法執行
```

**正確處理**：
```bash
# 使用 required_permissions: ["all"] 重新執行
run_terminal_cmd(
  command: "node .cursor/scripts/notification/notify-cursor-rules-failed.mjs \"pantheon\" \"推送完成\"",
  required_permissions: ["all"]
)
```

**常見適用場景**：
- 執行系統通知腳本（`notify-cursor-rules-failed.mjs`）
- 執行需要檔案系統權限的操作
- 執行需要系統調用的腳本
- 其他因 sandbox 限制而失敗的操作

**注意事項**：
- 此處理方式僅適用於「權限不足」導致的失敗，不適用於其他類型的錯誤（如語法錯誤、參數錯誤等）
- 如果使用 `required_permissions: ["all"]` 後仍然失敗，應停止並報告錯誤，等待用戶處理
- 此處理方式不需要在 chat 中特別說明，但可以在執行後簡要記錄（可選）

### 用例 2：Node 記憶體不足導致 eslint --fix（format-and-lint）階段中斷（JS heap out of memory）

**問題描述**：
- 在執行 `agent-commit` 流程時，lint 階段會跑 `pnpm run format-and-lint`
- 於 `eslint --fix ...` 過程中，Node v18 因預設 heap 限制/機器可用記憶體不足而爆掉
- 常見錯誤訊息：`FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory`
- **這不是程式碼錯誤**：流程中斷，因此**沒有產生 commit**；你的檔案變更仍停在 working tree

**判斷標準**：
- 失敗發生在 lint / format 階段（`pnpm run format-and-lint`）
- 錯誤訊息包含 `heap out of memory` / `Reached heap limit` / `Allocation failed`
- `git status` 仍顯示大量檔案變更（表示未 commit）

**處理方式**：
- **立即採用**：用加大 Node heap 的方式重跑 lint，讓 `agent-commit` 能走完並產生 commit
- 建議使用：
  - `NODE_OPTIONS=--max-old-space-size=8192 pnpm run format-and-lint`
- lint 成功後，再重新執行原本的 `agent-commit`

**執行範例**：

**錯誤情況**（示意）：
```bash
pnpm run agent-commit --type=feat --ticket=FE-1234 --message="..."
# ... eslint --fix ...
# FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory
# -> 流程中斷，未產生 commit
```

**正確處理**：
```bash
# 1) 確認變更仍在 working tree（避免誤以為變更遺失）
git status

# 2) 加大 heap 重跑 lint（讓 eslint --fix 跑完）
NODE_OPTIONS=--max-old-space-size=8192 pnpm run format-and-lint

# 3) 回到原流程重跑 agent-commit
pnpm run agent-commit --type=feat --ticket=FE-1234 --message="..."
```

**注意事項**：
- 如果 `8192` 仍不足，可視機器資源調整（例如 12288 / 16384），但請避免超過可用記憶體造成系統換頁（swap）反而更慢或卡死
- 若只在 CI / 特定機器發生，優先視為該環境資源限制問題，而非程式碼或 ESLint 規則錯誤

## 使用流程

當 AI 遇到問題時，應遵循以下流程：

```
遇到錯誤或異常
    ↓
查詢此障礙排除指南
    ↓
是否有對應的用例？
    ├─ 是 → 按照指南中的處理方式執行（無需詢問）
    └─ 否 → 按照一般錯誤處理流程（報告錯誤、詢問用戶等）
```

## 新增用例

**CRITICAL**: 此指南應持續擴充，當發現新的常見問題和解決方案時，應新增對應的用例。

**新增用例的格式**：
- **問題描述**：清楚說明問題的表現和常見場景
- **判斷標準**：如何判斷是否屬於此問題
- **處理方式**：具體的解決步驟
- **執行範例**：提供錯誤情況和正確處理的範例
- **常見適用場景**：列出適用此處理方式的場景
- **注意事項**：說明限制條件和例外情況

## 與其他規則的整合

此指南與以下規則緊密相關：

1. **ai-decision-making-priorities.mdc**：定義了「先詢問再修改」的原則，但此指南中的用例已明確授權 AI 可以直接處理，無需詢問
2. **chat-report-guideline.mdc**：定義了通知腳本需要使用 `required_permissions: ["all"]`，此指南將其擴展為通用的障礙排除用例

**重要**：此指南中的用例優先級高於一般規則中的「詢問原則」。當遇到指南中定義的問題時，AI 應直接按照指南處理，無需額外詢問用戶。

## 檢查清單

當 AI 遇到問題時，應確認：

- [ ] 是否已查詢此障礙排除指南？
- [ ] 是否有對應的用例？
- [ ] 是否按照指南中的方式處理？
- [ ] 處理後是否成功解決問題？
- [ ] 如果仍未解決，是否已報告錯誤並等待用戶處理？
