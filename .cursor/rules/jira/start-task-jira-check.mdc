---
description: 在 start-task 檢查 Jira 單時需要遵守的原則，特別是優先檢查 RD 提供的建議
alwaysApply: false
---
# Start-Task Jira Ticket 檢查原則

此規則定義了在執行 `start-task` 指令時，檢查和分析 Jira ticket 時需要遵守的原則。

## 適用場景

此規則適用於 `start-task` 指令執行過程中，當 AI 需要：
- 讀取 Jira ticket 信息
- 分析 ticket 的需求和描述
- 制定開發計劃
- 顯示 ticket 信息給用戶

## 核心原則：優先檢查 RD 建議

**CRITICAL**: 在分析 Jira ticket 時，**必須優先檢查**是否有 RD（開發者）提供的建議或指示，特別是標記給 AI 的內容。

### 檢查位置

在讀取 Jira ticket 信息後，必須檢查以下位置是否有 RD 建議：

1. **Ticket 描述（Description）**
   - 檢查描述內容中是否包含標記給 AI 的建議
   - 需要解析 Jira 的結構化描述格式（ADF - Atlassian Document Format）

2. **Ticket 評論（Comments）**
   - 檢查所有評論中是否包含標記給 AI 的建議
   - 優先檢查最新的評論

3. **Ticket 標題（Summary）**
   - 檢查標題中是否包含特殊標記

### 搜尋格式（不區分大小寫）

必須搜尋以下格式的標記：

- `for AI`
- `to AI`
- `AI suggestion`
- `AI suggestion:`
- `for AI:`
- `to AI:`
- `@AI`（如果 Jira 支持 @ 提及功能）

### 處理流程

**如果找到 RD 建議：**

1. **優先顯示**：在顯示 ticket 信息時，必須優先顯示 RD 建議，並明確標記
2. **納入計劃**：將 RD 建議納入開發計劃的優先考慮事項
3. **明確標記**：在分析結果中明確標記哪些是 RD 的建議，哪些是 AI 的推斷
4. **詢問確認**：在詢問用戶確認計劃時，特別詢問 RD 建議是否理解正確

**如果未找到 RD 建議：**

- 按照標準流程分析 ticket 並制定計劃
- 基於 ticket 類型、描述等進行常規分析

### 顯示格式範例

當找到 RD 建議時，應該在顯示 ticket 信息時使用以下格式：

```
📋 Jira Ticket 信息
============================================================
單號: FE-7846
標題: [Ticket Summary]
類型: Feature
狀態: In Progress
負責人: [Assignee]
優先級: High

🎯 RD 建議（優先處理）
============================================================
[顯示找到的 RD 建議內容，明確標記來源]

📝 描述:
[顯示完整的 ticket 描述]

🎯 初步開發計劃
============================================================
[基於 RD 建議和 ticket 內容制定的計劃]
```

### 實施要求

在 `start-task.mjs` 腳本中，當執行以下函數時必須遵守此原則：

1. **`getJiraTicketInfo(ticket)`**：
   - 獲取 ticket 信息時，同時獲取評論（comments）
   - 確保返回的數據包含完整的描述和評論

2. **`analyzeTicketAndPlan(ticketData)`**：
   - 在分析 ticket 之前，先檢查是否有 RD 建議
   - 如果找到建議，優先處理並納入計劃
   - 在返回的分析結果中明確標記 RD 建議

3. **顯示分析結果時**：
   - 優先顯示 RD 建議
   - 明確區分 RD 建議和 AI 推斷
   - 在制定計劃時優先考慮 RD 建議

### 範例場景

**場景 1：描述中包含 RD 建議**

```
Ticket 描述：
這是一個新功能開發。

for AI: 請優先考慮使用現有的 UserProfile 組件，不要重新創建。
需要特別注意響應式設計，確保在移動端正常顯示。
```

**處理方式**：
- 在顯示 ticket 信息時，優先顯示 "for AI" 標記的建議
- 在制定開發計劃時，將「使用現有 UserProfile 組件」作為優先事項
- 在計劃中明確標記這是 RD 的建議

**場景 2：評論中包含 RD 建議**

```
評論（最新）：
@AI suggestion: 這個功能需要與後端 API /api/v2/users 整合，
請確保使用 createCustomizeQuery 而不是直接使用 fetch。
```

**處理方式**：
- 檢查評論時發現 "AI suggestion" 標記
- 在顯示 ticket 信息時，將此評論作為 RD 建議優先顯示
- 在制定計劃時，明確要求使用 `createCustomizeQuery`

## AI 獨立完成項目的標記和 MR 處理

### 標記 AI 獨立完成的項目

**CRITICAL**: 當 AI 使用 `start-task` 獨立完成一個項目時（即從開始到完成都由 AI 執行，用戶僅確認計劃），必須在保存開發計劃時標記為 AI 獨立完成。

**標記方式**：
- 在 `startTaskInfo` 對象中添加 `aiCompleted: true` 標記
- 此標記用於後續 MR 時自動添加 AI label 和開發方案

**判斷標準**：
- 項目從 `start-task` 開始
- 開發計劃由 AI 制定並經用戶確認
- 開發過程主要由 AI 執行（用戶可能提供反饋或調整，但核心開發由 AI 完成）
- 最終由 AI 執行 `cr` 或 `cr-single-ticket` 建立 MR

### MR 時自動處理（cr 系列指令）

當執行 `cr` 或 `cr-single-ticket` 指令建立 MR 時，如果檢測到是由 AI 使用 `start-task` 獨立完成的項目，必須自動執行以下操作：

#### 1. 自動添加 AI Label

**實施位置**：`.cursor/scripts/cr/create-mr.mjs` 的 `determineLabels()` 函數

**邏輯**：
- 檢查是否存在 `start-task` 的 Git notes（透過 `readStartTaskInfo()`）
- 如果存在，自動添加 `AI` label
- 此邏輯已實現在 `create-mr.mjs` 第 1177-1181 行

#### 2. 自動檢附開發方案到 MR 留言

**實施位置**：`.cursor/scripts/cr/create-mr.mjs` 的 `main()` 函數

**邏輯**：
- 檢查是否存在 `start-task` 的 Git notes
- 如果存在且包含 `suggestedSteps`，將開發方案添加到 MR description
- **重要**：開發方案必須以**最終版本**為主，即從 Git notes 讀取最新的計劃信息
- 避免使用開發過程中可能被調整過的臨時計劃

**開發方案格式**：
```markdown
## 🎯 開發計劃

本 MR 由 `start-task` 命令啟動，以下是初步制定的開發計劃：

- [步驟 1]
- [步驟 2]
- [步驟 3]
...

**Jira Ticket:** [TICKET]
**標題:** [SUMMARY]
**類型:** [ISSUE_TYPE]
**狀態:** [STATUS]
**負責人:** [ASSIGNEE]
**優先級:** [PRIORITY]
**啟動時間:** [STARTED_AT]
```

**實施細節**：
- 此邏輯已實現在 `create-mr.mjs` 第 1769-1791 行
- 開發方案從 Git notes 讀取，確保是最終版本
- 如果開發過程中用戶調整過計劃方向，Git notes 應該在最終確認時更新

#### 3. 確保開發方案為最終版本

**CRITICAL**: 開發方案必須反映最終確認的版本，而非開發過程中的臨時版本。

**實施要求**：
1. **在 start-task 確認時保存**：當用戶確認開發計劃時，將最終版本保存到 Git notes
2. **在開發過程中更新**：如果用戶在開發過程中調整了計劃方向，應該更新 Git notes 中的計劃
3. **在 MR 時讀取最新版本**：`readStartTaskInfo()` 從 Git notes 讀取，確保獲取的是最新版本

**更新 Git notes 的時機**：
- 用戶確認初始計劃時（`start-task` 確認階段）
- 用戶明確要求調整計劃時
- 開發完成準備建立 MR 前（可選，用於最終確認）
- **在 commit 之後**：當使用 `agent-commit.mjs` 或類似腳本進行 commit 後，會自動檢查並複製 Git notes 到新 commit，確保 `create-mr.mjs` 能夠讀取到 start-task 信息

**注意事項**：
- Git notes 使用 `--ref=start-task` 自定義引用，不會影響 commit history
- 使用 `git notes --ref=start-task add -f` 可以強制更新現有 notes
- 確保在建立 MR 前，Git notes 中的計劃是最終確認的版本

### 完成修改後的確認與自動提交流程

**CRITICAL**: 當 AI 使用 `start-task` 完成代碼修改後，必須在 chat 中與用戶確認修改計畫，確認無誤後自動執行 `cr` 命令提交 MR。

#### 流程步驟

1. **讀取開發計劃**：
   - 使用 `git notes --ref=start-task show HEAD` 讀取最新的開發計劃
   - 解析 JSON 格式的 `startTaskInfo` 對象

2. **顯示修改計畫**：
   - 在 chat 中顯示當前任務信息（分支、ticket、標題）
   - 顯示已完成的開發步驟（基於 `suggestedSteps`）
   - 顯示本次修改的摘要（變更的檔案和主要改動）
   - 可以使用 `git status` 和 `git diff --stat` 獲取變更信息

3. **詢問確認**：
   - 明確詢問用戶「目前的修改計畫是否正確無誤？」
   - 說明如果確認，將自動執行 `cr` 命令提交 MR

4. **自動執行 cr 命令**：
   - 如果用戶確認（回答「是」、「正確」、「可以」、「確認」等），自動執行 `cr` 命令
   - `cr` 命令會自動：
     - 添加 `AI` label（檢測到 start-task 的 Git notes）
     - 檢附開發計畫到 MR description（從 Git notes 讀取最終版本）
     - **注意：** AI review 提交功能已暫時停用，待開放時另行通知

5. **更新開發計劃**（如需要）：
   - 如果用戶在開發過程中調整了計劃方向，應該更新 Git notes
   - 使用 `git notes --ref=start-task add -f` 強制更新
   - 確保 MR 時使用的是最終確認的版本

#### 顯示格式範例

```
✅ 修改完成！以下是目前的修改計畫：

📋 當前任務信息
============================================================
分支: feature/FE-7846
Ticket: FE-7846
標題: [Ticket Summary]

✅ 已完成的開發步驟：
- 1. 分析需求並確認技術方案 ✓
- 2. 創建必要的組件和頁面 ✓
- 3. 實現核心功能邏輯 ✓
- 4. 添加樣式和交互效果 ✓
- 5. 編寫測試用例 ✓
- 6. 進行代碼審查和測試 ✓

📝 本次修改摘要：
- 修改檔案: src/modules/user/components/UserProfile/index.tsx
- 新增檔案: src/modules/user/components/UserProfile/UserProfileCard.tsx
- 主要改動: 實現用戶資料顯示功能

❓ 目前的修改計畫是否正確無誤？如果確認，我將自動執行 `cr` 命令提交 MR。
```

### 實施檢查清單

在 `start-task.mjs` 中：
- [x] 添加 `readStartTaskInfo()` 函數讀取開發計劃（已實現）
- [x] 添加 `formatDevelopmentPlan()` 函數格式化顯示（已實現）
- [ ] 保存開發計劃時，標記是否為 AI 獨立完成（`aiCompleted: true`）
- [ ] 確保 Git notes 保存的是最終確認的計劃版本
- [ ] 如果用戶調整計劃，更新 Git notes

在 `agent-commit.mjs` 中：
- [x] 在 commit 之後，檢查並複製 start-task Git notes 到新 commit（已實現）
- [x] 如果父 commit 或 base commit 有 Git notes，自動複製到當前 commit（已實現）

在 `create-mr.mjs` 中：
- [x] 檢查 `startTaskInfo` 並自動添加 `AI` label（已實現）
- [x] 檢查 `startTaskInfo` 並添加開發方案到 MR description（已實現）
- [x] 確保從 Git notes 讀取的是最新版本（`readStartTaskInfo()` 已實現）
- [x] 增強 `readStartTaskInfo()` 函數，如果當前 commit 沒有 Git notes，嘗試從父 commit 或 base commit 讀取（已實現）

在 AI Chat 流程中：
- [ ] 完成修改後，讀取並顯示開發計劃
- [ ] 詢問用戶確認修改計畫
- [ ] 用戶確認後自動執行 `cr` 命令

## 注意事項

1. **格式靈活性**：搜尋時不區分大小寫，但必須完整匹配關鍵字（如 "for AI" 必須是完整詞組）
2. **優先級**：RD 建議的優先級高於 AI 的常規推斷
3. **明確標記**：必須明確區分哪些是 RD 建議，哪些是 AI 推斷，避免混淆
4. **完整性**：如果 ticket 有多個 RD 建議，必須全部顯示，不能遺漏
5. **上下文理解**：理解 RD 建議的上下文，確保建議被正確納入開發計劃
6. **最終版本原則**：開發方案必須以最終確認的版本為主，避免使用開發過程中的臨時版本
7. **自動化處理**：AI 獨立完成的項目在建立 MR 時必須自動添加 AI label 和開發方案，無需手動操作
