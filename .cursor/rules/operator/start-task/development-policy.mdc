---
description: 定義 operator 在 start-task 程序時需遵守的開發原則，包含開發流程、報告生成和 MR 處理
alwaysApply: false
---
# Start-Task 開發原則

此規則定義了在執行 `start-task` 指令進行開發時，必須遵守的開發原則和流程規範。

## 適用場景

此規則適用於 `start-task` 指令執行過程中的所有開發階段，包括：
- 開發計劃確認和執行
- 代碼修改和實現
- 開發完成後的報告生成
- Commit 前的確認流程
- MR 建立和報告檢附

## AI 獨立完成項目的標記和 MR 處理

### 標記 AI 獨立完成的項目

**CRITICAL**: 當 AI 使用 `start-task` 獨立完成一個項目時（即從開始到完成都由 AI 執行，用戶僅確認計劃），必須在保存開發計劃時標記為 AI 獨立完成。

**標記方式**：
- 在 `startTaskInfo` 對象中添加 `aiCompleted: true` 標記
- 此標記用於後續 MR 時自動添加 AI label 和開發方案

**判斷標準**：
- 項目從 `start-task` 開始
- 開發計劃由 AI 制定並經用戶確認
- 開發過程主要由 AI 執行（用戶可能提供反饋或調整，但核心開發由 AI 完成）
- 最終由 AI 執行 `cr single-ticket` 或 `cr multiple-ticket` 建立 MR

### MR 時自動處理（cr 系列指令）

當執行 `cr single-ticket` 或 `cr multiple-ticket` 指令建立 MR 時，如果檢測到是由 AI 使用 `start-task` 獨立完成的項目，必須自動執行以下操作：

#### 1. 自動添加 AI Label

**實施位置**：`.cursor/scripts/cr/create-mr.mjs` 的 `determineLabels()` 函數

**邏輯**：
- 檢查是否存在 `start-task` 的 Git notes（透過 `readStartTaskInfo()`）
- 如果存在，自動添加 `AI` label
- 此邏輯已實現在 `create-mr.mjs` 第 1177-1181 行

#### 2. 自動檢附開發方案到 MR 留言

**實施位置**：`.cursor/scripts/cr/create-mr.mjs` 的 `main()` 函數

**邏輯**：
- 檢查是否存在 `start-task` 的 Git notes
- 如果存在且包含 `suggestedSteps`，將開發方案添加到 MR description
- **重要**：開發方案必須以**最終版本**為主，即從 Git notes 讀取最新的計劃信息
- 避免使用開發過程中可能被調整過的臨時計劃

**開發方案格式**：
```markdown
## 🎯 開發計劃

本 MR 由 `start-task` 命令啟動，以下是初步制定的開發計劃：

- [步驟 1]
- [步驟 2]
- [步驟 3]
...

## 📋 關聯單資訊

| 項目 | 值 |
|---|---|
| **單號** | [TICKET](URL) |
| **標題** | [SUMMARY] |
| **類型** | [ISSUE_TYPE] |
```

**說明**：
- 開發計劃區塊：只包含開發步驟，不含關聯單資訊
- 關聯單資訊區塊：獨立區塊，僅包含單號（含超連結）、標題、類型三項

**實施細節**：
- 開發計劃由 `generateDevelopmentPlanSection()` 函數生成
- 關聯單資訊由 `generateRelatedTicketsSection()` 函數生成
- 開發方案從 Git notes 讀取，確保是最終版本
- 如果開發過程中用戶調整過計劃方向，Git notes 應該在最終確認時更新

#### 3. 確保開發方案為最終版本

**CRITICAL**: 開發方案必須反映最終確認的版本，而非開發過程中的臨時版本。

**實施要求**：
1. **在 start-task 確認時保存**：當用戶確認開發計劃時，將最終版本保存到 Git notes
2. **在開發過程中更新**：如果用戶在開發過程中調整了計劃方向，應該更新 Git notes 中的計劃
3. **在 MR 時讀取最新版本**：`readStartTaskInfo()` 從 Git notes 讀取，確保獲取的是最新版本

**更新 Git notes 的時機**：
- 用戶確認初始計劃時（`start-task` 確認階段）
- 用戶明確要求調整計劃時
- 開發完成準備建立 MR 前（可選，用於最終確認）
- **在 commit 之後**：當使用 `agent-commit.mjs` 或類似腳本進行 commit 後，會自動檢查並複製 Git notes 到新 commit，確保 `create-mr.mjs` 能夠讀取到 start-task 信息

**注意事項**：
- Git notes 使用 `--ref=start-task` 自定義引用，不會影響 commit history
- 使用 `git notes --ref=start-task add -f` 可以強制更新現有 notes
- 確保在建立 MR 前，Git notes 中的計劃是最終確認的版本

---

## 開發完成後的報告生成

**CRITICAL**: 開發完成後，必須生成開發報告。報告內容除了原始的開發計畫外，必須根據 Jira card 的類型包含額外資訊。

### 報告基礎結構

所有類型的開發報告都必須包含：

1. **基本信息**
   - Jira Ticket 編號和標題
   - 開發分支名稱
   - 開發計劃摘要

2. **變更摘要**
   - 新增的檔案列表
   - 修改的檔案列表
   - 刪除的檔案列表

3. **開發步驟完成狀態**
   - 列出所有開發步驟
   - 標記每個步驟的完成狀態

### Bug 類型報告要求

當 Jira card 類型為 **Bug** 時，報告必須包含以下額外資訊：

#### 1. 影響範圍（Affect Range）

**必須說明**：
- 受影響的功能模組
- 受影響的頁面或組件
- 受影響的用戶群體或使用場景
- 是否影響其他相關功能

**格式範例**：
```
### 影響範圍（Affect Range）

- **受影響模組**: 用戶管理模組 > 用戶資料頁面
- **受影響組件**: `UserProfile`, `UserAvatar`
- **受影響場景**: 用戶在編輯個人資料時，頭像上傳功能異常
- **關聯影響**: 無其他關聯功能受影響
```

#### 2. 根本原因（Root Cause）

**必須說明**：
- 問題發生的技術原因
- 導致問題的代碼邏輯
- 為什麼之前沒有發現此問題

**格式範例**：
```
### 根本原因（Root Cause）

此 Bug 的根本原因是在 `uploadAvatar` 函數中，未正確處理圖片格式驗證：
- 原代碼僅檢查了 `image/*` MIME type，但未驗證實際檔案內容
- 當用戶上傳被偽裝的非圖片檔案時，後端處理失敗但前端未顯示錯誤
- 此問題在之前版本中未被發現，因為測試用例未覆蓋此邊界情況
```

#### 3. 造成問題的單號

**必須說明**：
- 導致此 Bug 的原始 commit 或 MR
- 相關的 Jira ticket（如果有）
- 引入問題的版本號

**格式範例**：
```
### 造成問題的單號

- **引入問題的 MR**: [MR !2845](https://gitlab.service-hub.tech/frontend/fluid-two/-/merge_requests/2845)
- **相關 Jira Ticket**: [FE-7234](https://innotech.atlassian.net/browse/FE-7234)
- **引入版本**: v5.34.0
- **說明**: 該 MR 在重構圖片上傳邏輯時，誤刪了格式驗證的代碼
```

#### 4. 改動前後邏輯差異

**必須說明**：
- 修改前的代碼邏輯（簡要描述）
- 修改後的代碼邏輯（簡要描述）
- 關鍵差異點
- 為什麼這個修改能解決問題

**格式範例**：
```
### 改動前後邏輯差異

#### 修改前邏輯
- `uploadAvatar` 函數直接將檔案傳送到後端，無前端驗證
- 錯誤處理僅捕獲網路錯誤，忽略後端返回的格式錯誤

#### 修改後邏輯
- 新增 `validateImageFile` 函數，在上傳前驗證檔案格式和大小
- 增強錯誤處理，捕獲並顯示後端返回的所有錯誤類型
- 添加用戶友好的錯誤提示訊息

#### 關鍵差異
| 項目 | 修改前 | 修改後 |
|-----|------|------|
| 前端驗證 | 無 | 檢查 MIME type 和檔案頭 |
| 錯誤處理 | 僅網路錯誤 | 所有錯誤類型 |
| 用戶提示 | 無 | 明確的錯誤訊息 |

#### 解決原因
此修改通過在前端添加驗證層，防止無效檔案被上傳，並提供清晰的錯誤反饋給用戶。
```

### Request 類型報告要求

當 Jira card 類型為 **Story**、**Task**、**Feature** 或其他需求類型時，報告必須包含以下額外資訊：

#### 1. 預期效果

**必須說明**：
- 功能實現後的預期行為
- 用戶體驗的改變
- 與需求文件的對應關係

**格式範例**：
```
### 預期效果

#### 功能行為
- 用戶可以在設定頁面切換深色/淺色主題
- 主題選擇會即時生效，無需重新載入頁面
- 用戶的主題偏好會被保存到 localStorage

#### 用戶體驗改變
- 新增主題切換開關，位於設定頁面右上角
- 切換時有平滑的過渡動畫效果
- 支援系統主題偏好自動偵測

#### 需求對應
- ✅ 需求 1.1: 提供主題切換功能 → 已實現
- ✅ 需求 1.2: 保存用戶偏好 → 已實現
- ✅ 需求 1.3: 支援系統偏好 → 已實現
```

#### 2. 需求覆蓋率

**必須說明**：
- 需求文件中的所有要求
- 每個要求的實現狀態
- 未實現項目的原因（如有）

**格式範例**：
```
### 需求覆蓋率

| 需求項目 | 狀態 | 說明 |
|--------|-----|-----|
| 主題切換開關 | ✅ 已實現 | 位於設定頁面 |
| 即時生效 | ✅ 已實現 | 使用 CSS 變數實現 |
| 持久化存儲 | ✅ 已實現 | localStorage |
| 系統偏好偵測 | ✅ 已實現 | prefers-color-scheme |
| 動畫效果 | ✅ 已實現 | 300ms 過渡 |
| 多主題支援 | ⏸️ 延後 | 此版本僅支援深淺兩種，多主題將在下一版本實現 |

**覆蓋率**: 5/6 (83.3%)

**說明**: 多主題支援因設計稿尚未確定，暫時延後至下一版本。
```

#### 3. 潛在影響風險報告

**必須說明**：
- 對現有功能的影響
- 可能的副作用
- 需要注意的邊界情況
- 建議的測試重點

**格式範例**：
```
### 潛在影響風險報告

#### 對現有功能的影響

| 功能 | 影響程度 | 說明 |
|-----|--------|-----|
| 整體樣式 | 🟡 中度 | 所有使用 CSS 變數的組件會受主題影響 |
| 圖表顏色 | 🟢 低度 | 圖表組件已適配主題變數 |
| 第三方組件 | 🟡 中度 | 部分第三方組件可能需要額外適配 |

#### 可能的副作用

1. **樣式不一致風險**
   - 某些硬編碼顏色的組件可能在深色主題下顯示異常
   - 建議: 全面檢查所有頁面在深色主題下的顯示效果

2. **性能影響**
   - 主題切換會觸發大量 CSS 重新計算
   - 影響: 在低端設備上可能有短暫卡頓
   - 建議: 已添加 will-change 優化，影響可忽略

3. **localStorage 衝突**
   - 使用 `theme-preference` 作為存儲 key
   - 風險: 如果其他功能使用相同 key 會造成衝突
   - 建議: 已確認無衝突

#### 邊界情況

- 用戶在 A 標籤頁切換主題，B 標籤頁不會即時同步（需重新載入）
- 若 localStorage 被禁用，主題選擇不會被保存
- 系統主題變更時，已手動設定的偏好會被保留

#### 建議測試重點

1. 所有頁面在深色主題下的樣式檢查
2. 主題切換的性能表現
3. 跨標籤頁的主題同步行為
4. localStorage 禁用情況下的降級處理
```

---

## 完成修改後的確認與自動提交流程

**CRITICAL**: 當 AI 使用 `start-task` 完成代碼修改後，必須在 chat 中與用戶確認修改計畫和開發報告，確認無誤後才能執行 `cr single-ticket` 命令提交 MR。

### 流程步驟

1. **讀取開發計劃**：
   - 使用 `git notes --ref=start-task show HEAD` 讀取最新的開發計劃
   - 解析 JSON 格式的 `startTaskInfo` 對象

2. **生成開發報告**：
   - 根據 Jira card 類型生成對應的報告內容
   - Bug 類型: 包含影響範圍、根本原因、造成問題單號、改動前後邏輯差異
   - Request 類型: 包含預期效果、需求覆蓋率、潛在影響風險

3. **顯示完整報告**：
   - 在 chat 中顯示當前任務信息（分支、ticket、標題）
   - 顯示已完成的開發步驟
   - 顯示本次修改的摘要
   - 顯示根據 Jira card 類型生成的額外報告內容

4. **等待用戶確認**：
   - **CRITICAL**: 必須明確詢問用戶確認報告內容
   - 等待用戶回應「是」、「確認」、「可以」等肯定回答
   - **禁止**在用戶確認前執行 commit 或 MR 操作

5. **執行 cr single-ticket 命令**：
   - 只有在用戶明確確認後，才執行 `cr single-ticket` 命令
   - 將用戶確認的報告內容檢附到 MR description

### 顯示格式範例

#### Bug 類型報告

```
✅ 開發完成！以下是開發報告，請確認：

📋 當前任務信息
============================================================
分支: feature/FE-7846
Ticket: [FE-7846](https://innotech.atlassian.net/browse/FE-7846)
標題: 修復用戶頭像上傳失敗問題
類型: Bug

✅ 已完成的開發步驟：
- 1. 分析問題原因 ✓
- 2. 定位問題代碼 ✓
- 3. 實現修復方案 ✓
- 4. 驗證修復效果 ✓

📝 變更摘要：
- 修改檔案: src/modules/user/utils/uploadAvatar.ts
- 新增檔案: src/modules/user/utils/validateImageFile.ts
- 主要改動: 添加圖片格式驗證邏輯

============================================================
📊 Bug 修復報告
============================================================

### 影響範圍（Affect Range）
- **受影響模組**: 用戶管理模組 > 用戶資料頁面
- **受影響組件**: `UserProfile`, `UserAvatar`
- **受影響場景**: 用戶在編輯個人資料時，頭像上傳功能異常

### 根本原因（Root Cause）
此 Bug 的根本原因是在 `uploadAvatar` 函數中，未正確處理圖片格式驗證...

### 造成問題的單號
- **引入問題的 MR**: [MR !2845](URL)
- **相關 Jira Ticket**: [FE-7234](URL)
- **引入版本**: v5.34.0

### 改動前後邏輯差異
| 項目 | 修改前 | 修改後 |
|-----|------|------|
| 前端驗證 | 無 | 檢查 MIME type 和檔案頭 |
| 錯誤處理 | 僅網路錯誤 | 所有錯誤類型 |

============================================================

❓ 以上開發報告是否正確無誤？確認後我將執行 `cr single-ticket` 命令提交 MR，並將此報告檢附到 MR 中。
```

#### Request 類型報告

```
✅ 開發完成！以下是開發報告，請確認：

📋 當前任務信息
============================================================
分支: feature/FE-7850
Ticket: [FE-7850](https://innotech.atlassian.net/browse/FE-7850)
標題: 新增深色主題切換功能
類型: Story

✅ 已完成的開發步驟：
- 1. 分析需求並確認技術方案 ✓
- 2. 創建主題切換組件 ✓
- 3. 實現 CSS 變數系統 ✓
- 4. 添加持久化存儲 ✓

📝 變更摘要：
- 新增檔案: src/components/ThemeSwitch/index.tsx
- 修改檔案: src/styles/variables.css
- 修改檔案: src/context/ThemeProvider.tsx

============================================================
📊 需求實現報告
============================================================

### 預期效果
- 用戶可以在設定頁面切換深色/淺色主題
- 主題選擇會即時生效，無需重新載入頁面
- 用戶的主題偏好會被保存到 localStorage

### 需求覆蓋率
| 需求項目 | 狀態 | 說明 |
|--------|-----|-----|
| 主題切換開關 | ✅ 已實現 | 位於設定頁面 |
| 即時生效 | ✅ 已實現 | 使用 CSS 變數實現 |
| 持久化存儲 | ✅ 已實現 | localStorage |

**覆蓋率**: 3/3 (100%)

### 潛在影響風險報告

#### 對現有功能的影響
| 功能 | 影響程度 | 說明 |
|-----|--------|-----|
| 整體樣式 | 🟡 中度 | 所有使用 CSS 變數的組件會受主題影響 |

#### 建議測試重點
1. 所有頁面在深色主題下的樣式檢查
2. 主題切換的性能表現

============================================================

❓ 以上開發報告是否正確無誤？確認後我將執行 `cr single-ticket` 命令提交 MR，並將此報告檢附到 MR 中。
```

---

## MR 報告檢附規則

**CRITICAL**: 當用戶確認開發報告後，必須將報告內容檢附到 MR description 中。

### 檢附格式

報告應該以 Markdown 格式添加到 MR description，結構如下：

```markdown
## 🎯 開發計劃

本 MR 由 `start-task` 命令啟動，以下是開發計劃：

- [步驟 1]
- [步驟 2]
...

## 📋 關聯單資訊

| 項目 | 值 |
|---|---|
| **單號** | [TICKET](URL) |
| **標題** | [SUMMARY] |
| **類型** | [ISSUE_TYPE] |

---

## 📊 開發報告

[根據 Jira card 類型的報告內容]
```

**說明**：
- 開發計劃與關聯單資訊為獨立區塊
- 關聯單資訊僅包含單號（含超連結）、標題、類型三項
- 開發報告為可選區塊，根據 Jira card 類型生成

### 實施位置

開發報告的更新和檢附由 `.cursor/scripts/operator/update-development-report.mjs` 腳本處理：

**腳本功能**：
- 讀取和更新 Git notes 中的 `startTaskInfo`
- 將開發報告保存到 `developmentReport` 欄位
- 生成格式化的 MR description（使用表格格式，避免換行問題）

**使用方式**：

```bash
# 更新開發報告（直接提供內容）
node .cursor/scripts/operator/update-development-report.mjs --report="<report-content>"

# 從檔案讀取報告內容
node .cursor/scripts/operator/update-development-report.mjs --report-file="<path-to-report-file>"

# 讀取當前的 startTaskInfo（JSON 格式）
node .cursor/scripts/operator/update-development-report.mjs --read

# 輸出格式化的 MR description（Markdown 格式）
node .cursor/scripts/operator/update-development-report.mjs --format
```

**AI 流程中的使用**：

1. AI 生成開發報告後，使用 `--report` 參數將報告內容保存到 Git notes
2. 執行 `cr single-ticket` 時，可以使用 `--format` 獲取格式化的 MR description
3. 將格式化的 description 傳遞給 MR 建立流程

---

## 實施檢查清單

在 `start-task.mjs` 中：
- [x] 保存開發計劃時，包含完整欄位（ticket, summary, issueType, status, assignee, priority, suggestedSteps, startedAt, developmentReport）
- [ ] 標記是否為 AI 獨立完成（`aiCompleted: true`）

在 `agent-commit.mjs` 中：
- [x] 在 commit 之後，檢查並複製 start-task Git notes 到新 commit
- [x] 如果父 commit 或 base commit 有 Git notes，自動複製到當前 commit

在 `create-mr.mjs` 中：
- [x] 檢查 `startTaskInfo` 並自動添加 `AI` label
- [x] 檢查 `startTaskInfo` 並添加開發方案到 MR description
- [x] `readStartTaskInfo()` 函數可從父 commit 或 base commit 讀取

在 `update-development-report.mjs` 中：
- [x] 讀取 Git notes 中的 `startTaskInfo`
- [x] 更新 `developmentReport` 欄位
- [x] 生成格式化的 MR description（表格格式）

在 AI Chat 流程中：
- [ ] 完成修改後，根據 Jira card 類型生成開發報告
- [ ] 顯示開發報告並詢問用戶確認
- [ ] **必須等待用戶確認後**，使用 `update-development-report.mjs` 保存報告
- [ ] 執行 `cr single-ticket` 命令建立 MR

---

## 注意事項

1. **用戶確認優先**：Commit 和 MR 操作必須在用戶確認報告後才能執行
2. **報告類型對應**：必須根據 Jira card 類型生成對應的報告內容
3. **最終版本原則**：開發方案和報告必須以最終確認的版本為主
4. **自動化處理**：AI 獨立完成的項目在建立 MR 時必須自動添加 AI label 和報告
5. **完整性要求**：Bug 報告必須包含所有四項額外資訊，Request 報告必須包含所有三項額外資訊
6. **影響分析**：潛在影響風險報告必須客觀評估，不可遺漏重要風險
7. **溯源要求**：Bug 報告中的「造成問題的單號」必須盡可能追溯到具體的 commit 或 MR
