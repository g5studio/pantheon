---
description: 定義 start-task 流程中的行為模式，包含謹慎模式、多工模式、快速模式和預設模式
alwaysApply: false
---

<!-- cSpell:disable -->

# Start-Task 行為模式

此規則定義了 `start-task` 流程中可選擇的行為模式，讓用戶可以根據不同的開發場景選擇最適合的工作風格。

## 適用場景

此規則適用於 `start-task` 指令執行的起始階段，當詢問用戶 Jira 單號**之前**，必須先詢問用戶選擇行為模式。

---

## 模式選擇流程

### 詢問格式

**CRITICAL**: 在詢問 Jira 單號之前，必須先詢問用戶選擇行為模式：

```
🚀 開始新任務

請選擇行為模式：

1️⃣ **謹慎模式** (Cautious)
   採最小風險改動，每步確認，適合 Hotfix

2️⃣ **多工模式** (Multi-Task)
   自動讀取所有 Sub-task，分階段開發，最後統一發 MR，適合大項目

3️⃣ **快速模式** (Fast)
   批次排程，目標導向自動推進，適合大量獨立小項目

4️⃣ **預設模式** (Default)
   標準流程，每階段確認

請輸入數字 (1-4) 或模式名稱，直接 Enter 使用預設模式：
```

### 模式識別

| 用戶輸入 | 識別為模式 |
|---|---|
| `1`、`謹慎`、`cautious`、`hotfix` | 謹慎模式 |
| `2`、`多工`、`multi`、`multi-task` | 多工模式 |
| `3`、`快速`、`fast`、`quick` | 快速模式 |
| `4`、`預設`、`default`、直接 Enter | 預設模式 |

---

## 模式一：謹慎模式 (Cautious Mode)

### 適用場景
- Hotfix 緊急修復
- 高風險變更
- 生產環境問題修復
- 需要最小化改動範圍的情況

### 核心原則

| 原則 | 說明 |
|---|---|
| **最小風險改動** | 只修改必要的代碼，不進行任何額外的重構或優化 |
| **目的性為主** | 專注於解決問題，不擴展範圍 |
| **逐步確認** | 每個改動步驟都需要用戶確認 |
| **影響評估** | 每次改動前必須評估影響範圍 |

### 行為規範

#### 1. 開發計劃制定
- 計劃必須**精簡明確**，只包含解決問題的必要步驟
- **禁止**包含「順便優化」、「額外改進」等項目
- 必須列出每個步驟的**影響範圍**

#### 2. 代碼修改
- **最小改動原則**：只修改導致問題的代碼
- **禁止**重構周邊代碼
- **禁止**更新非必要的依賴
- **禁止**修改代碼風格（除非是問題根源）

#### 3. 確認流程
```
每個改動步驟：
  ↓
顯示即將修改的內容和影響範圍
  ↓
等待用戶確認：「確定要執行此修改嗎？」
  ↓
用戶確認後才執行
  ↓
執行後再次確認：「此步驟已完成，是否繼續？」
```

#### 4. MR 建立
- MR 標題必須包含 `[HOTFIX]` 前綴（如適用）
- MR Description 必須包含：
  - 問題描述
  - 根本原因
  - 修復方案
  - 影響範圍評估
  - 回滾方案

### 顯示格式

```
🔒 謹慎模式已啟用

⚠️ 此模式下將採取最小風險改動策略：
- 只修改必要的代碼
- 每步驟需要確認
- 不進行額外優化

📋 請提供 Jira 單號：
```

---

## 模式二：多工模式 (Multi-Task Mode)

### 適用場景
- 大型需求開發
- 包含多個 Sub-task 的需求單
- 需要分階段完成的項目
- 需要獨立追蹤每個子任務進度的情況

### 核心原則

| 原則 | 說明 |
|---|---|
| **自動偵測 Sub-task** | 讀取需求單後自動識別所有子任務 |
| **分階段開發** | 按子任務順序分階段完成 |
| **獨立 Commit** | 每個子任務完成後獨立 commit |
| **統一 MR** | 全部完成後才發送一個 MR，關聯所有單號 |

### 🚨 多工模式 SOP（新增，必遵守）

**CRITICAL**：多工模式下，除本檔案的流程外，還必須遵守「確保」SOP（包含：子任務全量閱讀與排程、Requirement 分支、Sub-task commit、工時/狀態流轉、RD 通知、以及排程自動推進）。

**CRITICAL**：多工模式下，每次運作的「盤點/排程」僅針對 **狀態為 To Do** 且 **單內包含 AI 指示** 的子任務。

請參考：
- [multi-task-mode-sop.mdc](mdc:.cursor/rules/operator/start-task/multi-task-mode-sop.mdc)

### 行為規範

#### 1. 初始化流程

```
讀取主需求單
  ↓
自動識別所有 Sub-task
  ↓
生成開發排程計畫
  ↓
顯示計畫並等待用戶確認
  ↓
確認後開始分階段執行
```

#### 2. Sub-task 偵測

**CRITICAL**: 輸入的單號後，必須檢查是否有子任務：

```bash
# 使用 Jira API 獲取子任務列表
# 檢查 fields.subtasks 陣列
```

**顯示格式**：
```
📋 需求單分析完成

🎯 主需求: {PARENT_TICKET}
   標題: {PARENT_SUMMARY}

📌 已偵測到 {N} 個子任務：

| 序號 | 單號 | 標題 | 狀態 |
|---|---|---|---|
| 1 | {SUB_1} | {SUMMARY_1} | {STATUS_1} |
| 2 | {SUB_2} | {SUMMARY_2} | {STATUS_2} |
| ... | ... | ... | ... |

🗓️ 建議開發排程：

階段 1: {SUB_1} - {SUMMARY_1}
  開發計劃: [步驟列表]

階段 2: {SUB_2} - {SUMMARY_2}
  開發計劃: [步驟列表]

...

❓ 此開發排程是否正確？請回覆「confirm」或提供調整建議。
```

#### 3. 分階段執行

每個階段的執行流程：

```
階段 N 開始
  ↓
顯示當前階段信息
  ↓
執行開發步驟
  ↓
完成後獨立 commit（使用子任務單號作為 scope）
  ↓
顯示階段完成摘要
  ↓
自動進入下一階段（無需用戶確認）
```

**Commit 規則**：
- Scope 使用當前子任務單號
- 格式：`{type}({SUB_TICKET}): {message}`
- 範例：`feat(FE-1234-1): implement user profile component`

#### 4. 統一 MR 建立

全部階段完成後：

```
📋 所有階段已完成！

✅ 完成的子任務：
| 單號 | 標題 | Commit Hash |
|---|---|---|
| {SUB_1} | {SUMMARY_1} | {HASH_1} |
| {SUB_2} | {SUMMARY_2} | {HASH_2} |
| ... | ... | ... |

🔗 即將建立 MR，關聯以下單號：
- 主需求: {PARENT_TICKET}
- 子任務: {SUB_1}, {SUB_2}, ...

❓ 確認建立 MR？
```

**MR Description 格式**：
```markdown
## 📋 關聯單資訊

### 主需求
| 項目 | 值 |
|---|---|
| **單號** | [{PARENT}](URL) |
| **標題** | {SUMMARY} |
| **類型** | {TYPE} |

### 子任務

| 單號 | 標題 | Commit |
|---|---|---|
| [{SUB_1}](URL) | {SUMMARY_1} | {HASH_1} |
| [{SUB_2}](URL) | {SUMMARY_2} | {HASH_2} |

---

## 🎯 開發計劃

### 階段 1: {SUB_1}
- [步驟 1]
- [步驟 2]

### 階段 2: {SUB_2}
- [步驟 1]
- [步驟 2]

...
```

### 顯示格式

```
🔄 多工模式已啟用

📋 此模式下將：
- 自動讀取所有 Sub-task
- 分階段開發，每階段獨立 commit
- 全部完成後統一發送 MR

📋 請提供主需求 Jira 單號：
```

---

## 模式三：快速模式 (Fast Mode)

### 適用場景
- 大量獨立小項目批次處理
- 需要「排程確認後」目標導向自動推進的情況
- 希望全部完成後一次性回報給用戶確認

### 核心原則

| 原則 | 說明 |
|---|---|
| **排程確認** | 開始前先與用戶確認排程清單是否完整，是否要追加 |
| **目標導向推進** | 排程確認後自動推進，不做逐步確認 |
| **獨立分支** | 每張單使用獨立分支，完成一張後切回 main 再開下一張 |
| **最終通知** | 全部完成後才通知用戶回來確認總結 |

### 行為規範

快速模式的完整 SOP 請參考：
- [fast-mode.mdc](mdc:.cursor/rules/operator/start-task/fast-mode.mdc)

### 顯示格式

```
⚡ 快速模式已啟用

📋 此模式特點：
- ✅ 先確認排程清單（可追加）
- ✅ 排程確認後目標導向自動推進
- ✅ 每張單獨立分支（完成後切回 main 再開下一張）
- ✅ 全部完成後統一通知

📋 請提供 Jira 單號（支援多個，用逗號或空格分隔）：
```

---

## 模式四：預設模式 (Default Mode)

### 適用場景
- 一般開發任務
- 需要逐步確認的情況
- 初次使用 start-task 的用戶

### 行為規範

預設模式遵循現有的 `start-task` 流程，包含：

1. **開發計劃確認**：顯示計劃並等待用戶確認
2. **開發完成確認**：顯示修改摘要並等待確認
3. **MR 建立確認**：確認後才建立 MR

詳細流程請參考：
- [start-task.md](mdc:.cursor/commands/operator/start-task.md)
- [development-policy.mdc](mdc:.cursor/rules/operator/start-task/development-policy.mdc)

### 顯示格式

```
📋 預設模式已啟用

此模式為標準流程：
- 每階段需要確認
- 逐步推進

📋 請提供 Jira 單號：
```

---

## 模式狀態記錄

### Git Notes 擴展

**CRITICAL**: 選擇的模式必須記錄到 Git notes 中，供後續流程識別：

```json
{
  "ticket": "FE-1234",
  "operationMode": "cautious|multi-task|fast|default",
  "modeConfig": {
    // 模式特定配置
  },
  // ... 其他欄位
}
```

### 模式特定配置

#### 謹慎模式
```json
{
  "operationMode": "cautious",
  "modeConfig": {
    "confirmEachStep": true,
    "minimumChanges": true,
    "rollbackPlan": true
  }
}
```

#### 多工模式
```json
{
  "operationMode": "multi-task",
  "modeConfig": {
    "parentTicket": "FE-1234",
    "subTasks": ["FE-1234-1", "FE-1234-2"],
    "currentPhase": 1,
    "totalPhases": 2,
    "commitPerPhase": true,
    "singleMR": true
  }
}
```

#### 快速模式
```json
{
  "operationMode": "fast",
  "modeConfig": {
    "tickets": ["FE-1234", "FE-1235", "FE-1236"],
    "currentIndex": 0,
    "totalTasks": 3,
    "autoProgress": true,
    "branchNameStrategy": "ticket-only",
    "notifyAfterAll": true
  }
}
```

#### 預設模式
```json
{
  "operationMode": "default",
  "modeConfig": {}
}
```

---

## 模式對照表

| 特性 | 謹慎模式 | 多工模式 | 快速模式 | 預設模式 |
|---|---|---|---|---|
| **適用場景** | Hotfix | 大項目 | 獨立小項目排程 | 一般開發 |
| **輸入方式** | 單一單號 | 單一主單號 | 多個單號 | 單一單號 |
| **確認頻率** | 每步確認 | 計劃確認 | 僅排程確認 | 階段確認 |
| **Commit 策略** | 單一 Commit | 每階段 Commit | 每任務 Commit | 單一 Commit |
| **MR 策略** | 單一 MR | 統一 MR | 每任務 MR | 單一 MR |
| **通知時機** | 每步驟 | 全部完成 | 全部完成 | 每階段 |
| **風險等級** | 🟢 最低 | 🟡 中等 | 🟡 中等 | 🟢 低 |

---

## 檢查清單

### AI 執行 start-task 時的模式檢查

- [ ] 是否在詢問 Jira 單號**之前**詢問了模式選擇？
- [ ] 是否正確識別用戶選擇的模式？
- [ ] 是否將模式記錄到 Git notes 中？
- [ ] 是否根據模式調整了確認流程？
- [ ] 是否根據模式調整了 Commit/MR 策略？

### 模式切換禁止

**CRITICAL**: 一旦選擇模式並開始執行，**禁止**中途切換模式。如需切換，必須：

1. 完成或取消當前任務
2. 重新執行 `start-task`
3. 選擇新模式

---

## 注意事項

1. **模式選擇時機**：必須在詢問 Jira 單號之前完成
2. **模式識別靈活性**：支援數字、中文、英文等多種輸入方式
3. **預設值**：直接按 Enter 預設選擇「預設模式」
4. **模式記錄**：選擇的模式必須記錄到 Git notes 中
5. **錯誤處理**：各模式都必須有完善的錯誤處理機制
6. **通知規則**：遵循 `chat-report-guideline.mdc` 中的系統通知規則
