---
description: 在 start-task 檢查 Jira 單時需要遵守的原則，包含子任務偵測和優先檢查 RD 提供的建議
alwaysApply: false
---
# Start-Task Jira Ticket 檢查原則

此規則定義了在執行 `start-task` 指令時，檢查和分析 Jira ticket 時需要遵守的原則。

## 適用場景

此規則適用於 `start-task` 指令執行過程中，當 AI 需要：
- 讀取 Jira ticket 信息
- 分析 ticket 的需求和描述
- 制定開發計劃
- 顯示 ticket 信息給用戶

---

## 🚨 核心原則：子任務偵測（最高優先級）

**🚨 CRITICAL**: 讀取 Jira ticket 後，**必須立即**檢測是否為子任務，此步驟**絕對不可遺漏**。這是 start-task 流程中的**第一優先級檢查項目**。

### 偵測邏輯

在讀取 Jira ticket 資料後，**必須**執行以下檢查：

1. **檢查 issuetype**：確認 `fields.issuetype.name` 是否為 `Sub-task`
2. **提取父任務**：若為子任務，從 `fields.parent.key` 取得父任務單號

### 處理流程

| 條件 | 分支單號 | Commit 單號 | MR 關聯單號 |
|---|---|---|---|
| `issuetype.name === "Sub-task"` | **父任務單號**（`parent.key`） | 子任務單號 | 子任務 + 父任務 |
| `issuetype.name !== "Sub-task"` | 用戶提供的單號 | 用戶提供的單號 | 用戶提供的單號 |

### 強制顯示格式

**CRITICAL**: 若偵測到 ticket 為子任務，**必須**在 chat 中明確顯示以下資訊：

```
🔍 正在檢測 ticket 類型...
📌 偵測到此為子任務（Sub-task）
📋 子任務單號: {子任務單號}
📋 父任務單號: {parent.key}

ℹ️ 分支將使用父任務單號: feature/{父任務單號}
ℹ️ Commit 將使用子任務單號: ({子任務單號})
ℹ️ MR 將關聯兩個單號: {子任務單號}, {父任務單號}
```

### 記錄單號供後續使用

當偵測到子任務時，AI **必須**記錄以下資訊供後續流程使用：

| 用途 | 使用的單號 | 說明 |
|---|---|---|
| **創建分支** | 父任務單號 | 避免多個子任務各自建立分支 |
| **Commit scope** | 子任務單號 | 確保追蹤每個子任務的改動 |
| **MR 關聯** | 子任務 + 父任務 | 方便在 Jira 中追蹤完整需求進度 |
| **Git notes** | 子任務單號 | 作為主要 ticket 記錄 |

### 禁止行為

**🚨 CRITICAL**: 以下行為**絕對禁止**：

- ❌ 讀取到 `issuetype: "Sub-task"` 後不執行偵測邏輯
- ❌ 看到 `parent.key` 資料後不處理
- ❌ 使用子任務單號建立分支（應使用父任務單號）
- ❌ 在 MR 中只關聯子任務單號而遺漏父任務單號
- ❌ 未在 chat 中顯示子任務偵測結果

### 範例場景

**場景：用戶提供子任務單號 IN-107293**

```
AI 讀取 Jira ticket IN-107293
    ↓
檢測到: issueType = "Sub-task", parent.key = "IN-97676"
    ↓
在 chat 中顯示：
    「📌 偵測到此為子任務，父任務為 IN-97676
     分支將使用父任務單號: feature/IN-97676」
    ↓
創建分支: feature/IN-97676（使用父任務單號）
    ↓
後續 commit 使用 scope: (IN-107293)（使用子任務單號）
    ↓
MR 關聯: IN-107293, IN-97676（兩個都要）
```

**錯誤示範**：

```
❌ 錯誤流程：
AI 讀取 Jira ticket IN-107293
    ↓
看到 issueType = "Sub-task"（但未處理）
    ↓
直接創建分支: feature/IN-107293（錯誤！應使用父任務單號）
```

### 檢查清單

在讀取 Jira ticket 後，AI **必須**確認以下項目：

- [ ] 是否檢查了 `fields.issuetype.name`？
- [ ] 若為 `Sub-task`，是否提取了 `fields.parent.key`？
- [ ] 是否在 chat 中顯示了子任務偵測結果？
- [ ] 是否使用父任務單號創建分支？
- [ ] 是否記錄子任務單號供後續 commit 使用？

---

## 核心原則：優先檢查 RD 建議

**CRITICAL**: 在分析 Jira ticket 時，**必須優先檢查**是否有 RD（開發者）提供的建議或指示，特別是標記給 AI 的內容。

### 檢查位置

在讀取 Jira ticket 信息後，必須檢查以下位置是否有 RD 建議：

1. **Ticket 描述（Description）**
   - 檢查描述內容中是否包含標記給 AI 的建議
   - 需要解析 Jira 的結構化描述格式（ADF - Atlassian Document Format）

2. **Ticket 評論（Comments）**
   - 檢查所有評論中是否包含標記給 AI 的建議
   - 優先檢查最新的評論

3. **Ticket 標題（Summary）**
   - 檢查標題中是否包含特殊標記

### 搜尋格式（不區分大小寫）

必須搜尋以下格式的標記：

- `for AI`
- `to AI`
- `AI suggestion`
- `AI suggestion:`
- `for AI:`
- `to AI:`
- `@AI`（如果 Jira 支持 @ 提及功能）

### 處理流程

**如果找到 RD 建議：**

1. **優先顯示**：在顯示 ticket 信息時，必須優先顯示 RD 建議，並明確標記
2. **納入計劃**：將 RD 建議納入開發計劃的優先考慮事項
3. **明確標記**：在分析結果中明確標記哪些是 RD 的建議，哪些是 AI 的推斷
4. **詢問確認**：在詢問用戶確認計劃時，特別詢問 RD 建議是否理解正確

**如果未找到 RD 建議：**

- 按照標準流程分析 ticket 並制定計劃
- 基於 ticket 類型、描述等進行常規分析

### 顯示格式範例

當找到 RD 建議時，應該在顯示 ticket 信息時使用以下格式：

```
📋 Jira Ticket 信息
============================================================
單號: FE-7846
標題: [Ticket Summary]
類型: Feature
狀態: In Progress
負責人: [Assignee]
優先級: High

🎯 RD 建議（優先處理）
============================================================
[顯示找到的 RD 建議內容，明確標記來源]

📝 描述:
[顯示完整的 ticket 描述]

🎯 初步開發計劃
============================================================
[基於 RD 建議和 ticket 內容制定的計劃]
```

### 實施要求

在 `start-task.mjs` 腳本中，當執行以下函數時必須遵守此原則：

1. **`getJiraTicketInfo(ticket)`**：
   - 獲取 ticket 信息時，同時獲取評論（comments）
   - 確保返回的數據包含完整的描述和評論

2. **`analyzeTicketAndPlan(ticketData)`**：
   - 在分析 ticket 之前，先檢查是否有 RD 建議
   - 如果找到建議，優先處理並納入計劃
   - 在返回的分析結果中明確標記 RD 建議

3. **顯示分析結果時**：
   - 優先顯示 RD 建議
   - 明確區分 RD 建議和 AI 推斷
   - 在制定計劃時優先考慮 RD 建議

### 範例場景

**場景 1：描述中包含 RD 建議**

```
Ticket 描述：
這是一個新功能開發。

for AI: 請優先考慮使用現有的 UserProfile 組件，不要重新創建。
需要特別注意響應式設計，確保在移動端正常顯示。
```

**處理方式**：
- 在顯示 ticket 信息時，優先顯示 "for AI" 標記的建議
- 在制定開發計劃時，將「使用現有 UserProfile 組件」作為優先事項
- 在計劃中明確標記這是 RD 的建議

**場景 2：評論中包含 RD 建議**

```
評論（最新）：
@AI suggestion: 這個功能需要與後端 API /api/v2/users 整合，
請確保使用 createCustomizeQuery 而不是直接使用 fetch。
```

**處理方式**：
- 檢查評論時發現 "AI suggestion" 標記
- 在顯示 ticket 信息時，將此評論作為 RD 建議優先顯示
- 在制定計劃時，明確要求使用 `createCustomizeQuery`

## 開發流程相關規則

關於開發過程中的原則，包括：
- AI 獨立完成項目的標記和 MR 處理
- 開發完成後的報告生成
- 完成修改後的確認與自動提交流程
- MR 報告檢附規則

請參考：[development-policy.mdc](mdc:.cursor/rules/operator/start-task/development-policy.mdc)

## 注意事項

1. **格式靈活性**：搜尋時不區分大小寫，但必須完整匹配關鍵字（如 "for AI" 必須是完整詞組）
2. **優先級**：RD 建議的優先級高於 AI 的常規推斷
3. **明確標記**：必須明確區分哪些是 RD 建議，哪些是 AI 推斷，避免混淆
4. **完整性**：如果 ticket 有多個 RD 建議，必須全部顯示，不能遺漏
5. **上下文理解**：理解 RD 建議的上下文，確保建議被正確納入開發計劃
