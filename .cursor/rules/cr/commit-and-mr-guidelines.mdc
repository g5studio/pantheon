---
alwaysApply: true
---

# Commit and MR Guidelines

This rule defines the requirements for commit messages and merge requests in this project.

## Commit Message Requirements

### Language
- **MUST**: All commits must be written in **English only**
- Commit messages (both subject and body) must be in **English only**
- Chinese characters are not allowed in commit messages
- This is enforced by commitlint rules: `subject-english-only` and `body-english-only`

### Format
Commit messages must follow the conventional commit format:
```
{type}({scope}): {subject}

{body}
```

Where:
- **type**: Must be one of: `feat`, `fix`, `update`, `refactor`, `chore`, `test`, `style`, `revert`
- **scope**: Must be a valid Jira ticket (e.g., `FE-7838`, `IN-1234`)
- **subject**: 
  - Must be lowercase
  - Maximum 64 characters
  - Must be in English only
  - **MUST** accurately describe the purpose of the current changes (å¿…é ˆæº–ç¢ºæè¿°ç•¶å‰æ”¹å‹•çš„ç›®çš„)
- **body**: Optional, but if provided must be in English only

### Examples

âœ… **Correct:**
```
feat(FE-7838): enable new sport baseball in stg, dev, and demo environments
```

```
fix(IN-1234): resolve memory leak in sport game component

- Fixed memory leak in component cleanup
- Added proper event listener removal
```

âŒ **Incorrect:**
```
feat(FE-7838): å•Ÿç”¨æ–°çš„æ£’çƒé‹å‹•åŠŸèƒ½  // Chinese characters not allowed
```

```
fix(IN-1234): Fix memory leak  // Uppercase not allowed in subject
```

### Code Modification Restrictions During Commit Process

**CRITICAL**: During the commit process, if any issues are detected that require code modifications, **MUST** follow the strict protocol below. **NEVER** modify code and commit/push without explicit user consent.

**é‡è¦**ï¼šæ­¤è¦å‰‡å¿…é ˆèˆ‡ [ai-decision-making-priorities.mdc](mdc:.cursor/rules/ai-decision-making-priorities.mdc) è¦å‰‡ä¸€èµ·éµå®ˆã€‚ç•¶éœ€è¦ä¿®æ”¹ä»£ç¢¼æ™‚ï¼Œå¿…é ˆéµå¾ªã€Œå…ˆè©¢å•å†ä¿®æ”¹ã€çš„æœ€é«˜å„ªå…ˆç´šåŸå‰‡ï¼Œç„¡è«–ä»»å‹™ç›®æ¨™ç‚ºä½•ã€‚

#### Required Protocol

**MUST**: When any of the following situations are detected during the commit process:

1. **Code quality issues** (linting errors, code smells, architectural violations)
2. **Missing dependencies or imports**
3. **Type errors or compilation issues**
4. **Test failures**
5. **Rule violations** (Cursor rules, project conventions)
6. **Any other issues requiring code changes**

**The following protocol MUST be followed:**

1. **Immediately stop the commit process**
2. **Provide clear feedback in chat**:
   - Identify the specific issues detected
   - Explain what needs to be modified and why
   - Provide actionable guidance on how to fix the issues
   - List the specific files and locations that need modification

3. **Ask for user consent**:
   - **MUST** explicitly ask: "æ˜¯å¦éœ€è¦æˆ‘å”åŠ©ä¿®æ­£é€™äº›å•é¡Œï¼Ÿ"
   - **MUST** wait for user's explicit response before proceeding
   - **MUST NOT** assume user wants automatic fixes

4. **Wait for user response**:
   - If user says **"æ˜¯"**, **"å¯ä»¥"**, **"å¹«æˆ‘ä¿®æ­£"**, or similar affirmative responses â†’ Proceed with modifications
   - If user says **"å¦"**, **"ä¸ç”¨"**, **"æˆ‘è‡ªå·±ä¾†"**, or similar negative responses â†’ Stop and let user handle it
   - If user does not respond â†’ **DO NOT** proceed with modifications

5. **After modifications (only if user consented)**:
   - Show what was modified
   - Ask for user confirmation before committing
   - Only proceed with commit and push after user confirms

#### Prohibited Actions

**STRICTLY FORBIDDEN**: The following actions are **NEVER** allowed without explicit user consent:

- âŒ Automatically fixing code issues and committing
- âŒ Modifying code and pushing to remote without asking
- âŒ Assuming user wants fixes based on context
- âŒ Proceeding with commit after making silent modifications
- âŒ Skipping the consent step for "obvious" fixes

#### Examples

**Example 1: Linting Errors Detected**
```
Situation: ESLint errors found in src/components/Button.tsx

Action:
1. Stop commit process
2. Notify user in chat:
   "æª¢æ¸¬åˆ°ä»¥ä¸‹ ESLint éŒ¯èª¤éœ€è¦ä¿®æ­£ï¼š
   - src/components/Button.tsx:5:10 - 'unusedVariable' is assigned but never used
   - src/components/Button.tsx:12:3 - Missing return type annotation
   
   æ˜¯å¦éœ€è¦æˆ‘å”åŠ©ä¿®æ­£é€™äº›å•é¡Œï¼Ÿ"

3. Wait for user response
4. If user says "æ˜¯" â†’ Fix issues â†’ Show changes â†’ Ask for confirmation â†’ Commit
5. If user says "å¦" â†’ Stop and let user handle it
```

**Example 2: Missing Import**
```
Situation: Missing import detected in src/utils/helper.ts

Action:
1. Stop commit process
2. Notify user in chat:
   "æª¢æ¸¬åˆ° src/utils/helper.ts ä¸­ç¼ºå°‘å¿…è¦çš„ importï¼š
   - Line 15 ä½¿ç”¨äº† 'formatDate' ä½†æœª import
   
   æ˜¯å¦éœ€è¦æˆ‘å”åŠ©æ·»åŠ é€™å€‹ importï¼Ÿ"

3. Wait for user response
4. Only proceed if user explicitly consents
```

**Example 3: Rule Violation**
```
Situation: Cursor rule violation detected (e.g., Provider performing API calls)

Action:
1. Stop commit process
2. Notify user in chat:
   "æª¢æ¸¬åˆ°æ¶æ§‹è¦å‰‡é•è¦ï¼š
   - src/modules/user/context/UserContext.tsx ä¸­çš„ Provider çµ„ä»¶ç›´æ¥åŸ·è¡Œäº† API èª¿ç”¨
   - æ ¹æ“šæ¶æ§‹è¦ç¯„ï¼ŒProvider ä¸æ‡‰åŸ·è¡Œ side effects
   
   å»ºè­°å°‡ API èª¿ç”¨ç§»è‡³ Controller çµ„ä»¶ã€‚
   æ˜¯å¦éœ€è¦æˆ‘å”åŠ©é‡æ§‹é€™æ®µä»£ç¢¼ï¼Ÿ"

3. Wait for user response
4. Only proceed if user explicitly consents
```

**Example 4: User Explicitly Requests Fix**
```
Situation: User says "å¹«æˆ‘ä¿®æ­£é€™äº› lint éŒ¯èª¤"

Action:
1. Proceed with fixes (user has given explicit consent)
2. Show what was modified
3. Ask: "å·²ä¿®æ­£ä»¥ä¸‹å•é¡Œï¼Œæ˜¯å¦è¦ç¹¼çºŒ commitï¼Ÿ"
4. Wait for confirmation before committing
```

#### Integration with Commit Workflows

This restriction applies to **all commit-related commands and workflows**, including:

- `cr single-ticket` command
- `cr multiple-ticket` command
- `commit-and-push` command
- `agent-commit` script
- Any automated commit workflow
- Pre-commit hooks and checks

**Execution order when issues are detected:**

1. Detect issues during pre-commit checks
2. **Stop commit process immediately**
3. **Report issues in chat**
4. **Ask for user consent**
5. **Wait for user response**
6. **Only if user consents**: Fix issues â†’ Show changes â†’ Confirm â†’ Commit
7. **If user declines**: Stop and let user handle it

#### Exception: User-Initiated Fix Commands

**Exception**: If user explicitly requests fixes using commands like:
- "ä¿®æ­£é€™äº›éŒ¯èª¤"
- "å¹«æˆ‘ä¿®å¾©é€™äº›å•é¡Œ"
- "fix these issues"

These are considered explicit consent, and fixes can proceed. However, still:
- Show what will be modified
- Confirm before committing
- Never push without user confirmation

## Merge Request Requirements

### Pre-MR Push Requirement

**CRITICAL**: Before creating any MR, all committed changes **MUST** be pushed to the remote repository.

**Validation Steps**:
1. **Check for unpushed commits**:
   ```bash
   git log origin/{branch}..HEAD
   ```
2. **If unpushed commits exist**, push them first:
   ```bash
   git push origin {branch}
   ```
3. **Only proceed with MR creation** after all commits are successfully pushed

**Error Handling**:
- If push fails (due to permission, network, or other issues), **MUST** stop the MR creation process
- Notify the user with the specific error and suggested resolution
- Wait for user to resolve the push issue before retrying

### Development Plan Ticket Validation

**CRITICAL**: Before creating an MR, if a development plan exists for the current task, **MUST** validate that the ticket number in the development plan matches the current feature branch ticket number.

**Validation Steps**:
1. **Check for existing development plan** (from start-task notes or context)
2. **Extract ticket number from feature branch name** (e.g., `feature/FE-7893` â†’ `FE-7893`)
3. **Compare ticket numbers**:
   - If they match â†’ Proceed with MR creation
   - If they don't match â†’ **MUST** stop and notify the user

**Error Handling**:
- If ticket numbers mismatch, notify the user:
  ```
  é–‹ç™¼è¨ˆç•«å–®è™Ÿèˆ‡ç•¶å‰ feature branch å–®è™Ÿä¸ä¸€è‡´ï¼š
  - é–‹ç™¼è¨ˆç•«å–®è™Ÿ: {planTicket}
  - Feature branch å–®è™Ÿ: {branchTicket}
  
  è«‹ç¢ºèªæ˜¯å¦éœ€è¦æ›´æ–°é–‹ç™¼è¨ˆç•«æˆ–åˆ‡æ›åˆ°æ­£ç¢ºçš„åˆ†æ”¯ã€‚
  ```
- Wait for user confirmation before proceeding

### Information Validation Before MR Creation

**CRITICAL**: Before creating any MR, **ALL** required information **MUST** be successfully retrieved and validated. The MR creation process **MUST NOT** proceed if any required information is missing or cannot be obtained.

#### Required Information Checklist

The following information **MUST** be successfully retrieved before creating an MR:

1. **GitLab Information**
   - GitLab API connection status
   - Current user information (for assignee)
   - Project information
   - Branch information
   - Any other GitLab-related data required for MR creation

2. **Jira Ticket Information**
   - Jira ticket number (from branch name or commit message)
   - Jira ticket title/summary (for MR title)
   - Jira ticket status and validity
   - Fix version information (if applicable)
   - Any other Jira-related data required for MR creation

3. **MR Configuration Information**
   - Labels (UI version labels, FE Board, Static File, Vendor Customization, etc.)
   - Reviewer information (from command argument, user preference, or default)
   - Assignee information
   - Draft status preference
   - Any other MR configuration parameters

#### Error Handling and User Feedback

**MUST**: If any required information cannot be retrieved (due to network issues, user configuration problems, API errors, etc.):

1. **Immediately stop the MR creation process**
2. **Provide clear feedback in chat**:
   - Identify which specific information is missing or cannot be retrieved
   - Explain the root cause (network issue, configuration problem, etc.)
   - Provide actionable guidance on how to resolve the issue
   - List the specific steps the user needs to take to fix the problem

3. **Send system notification**:
   - Trigger a system notification to alert the user about the issue
   - Include the same information provided in the chat feedback
   - Ensure the notification is visible and actionable

4. **Wait for user resolution**:
   - Do not proceed with MR creation until all information is successfully retrieved
   - After user fixes the issue, re-validate all information before proceeding

#### Examples of Error Scenarios

**Example 1: Network Issue**
```
Error: Cannot connect to GitLab API
Action: 
- Stop MR creation
- Notify user: "ç„¡æ³•é€£æ¥åˆ° GitLab APIï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š"
- Send system notification
- Wait for user to resolve network issue
```

**Example 2: Missing Jira Ticket**
```
Error: Jira ticket FE-1234 not found or cannot be accessed
Action:
- Stop MR creation
- Notify user: "ç„¡æ³•å–å¾— Jira ticket FE-1234 çš„è³‡è¨Šï¼Œè«‹ç¢ºèªï¼š
  1. Ticket ç·¨è™Ÿæ˜¯å¦æ­£ç¢º
  2. æ˜¯å¦æœ‰æ¬Šé™å­˜å–è©² ticket
  3. Jira API é€£ç·šæ˜¯å¦æ­£å¸¸"
- Send system notification
- Wait for user to resolve issue
```

**Example 3: Missing User Configuration**
```
Error: MR_REVIEWER not set in .env.local
Action:
- Stop MR creation
- Notify user: "æœªè¨­å®š MR_REVIEWERï¼Œè«‹åœ¨ .env.local ä¸­è¨­å®šï¼š
  MR_REVIEWER=@username
  æˆ–ä½¿ç”¨ --reviewer åƒæ•¸æŒ‡å®š reviewer"
- Send system notification
- Wait for user to add configuration
```

**Example 4: Missing Label Information**
```
Error: Cannot determine UI version label from changed files
Action:
- Stop MR creation
- Notify user: "ç„¡æ³•è‡ªå‹•åˆ¤æ–· UI ç‰ˆæœ¬æ¨™ç±¤ï¼Œè«‹ç¢ºèªï¼š
  1. è®Šæ›´çš„æª”æ¡ˆè·¯å¾‘æ˜¯å¦æ­£ç¢º
  2. æª”æ¡ˆæ˜¯å¦åŒ…å« .v3. æˆ– .v4. æ¨™è¨˜
  3. æ˜¯å¦éœ€è¦æ‰‹å‹•æŒ‡å®šæ¨™ç±¤"
- Send system notification
- Wait for user to resolve or manually specify labels
```

#### Validation Process Flow

The MR creation process must follow this validation flow:

1. **Pre-validation Phase**:
   - Check network connectivity
   - Verify API credentials and permissions
   - Validate user configuration files

2. **Information Retrieval Phase**:
   - Retrieve GitLab information
   - Retrieve Jira ticket information
   - Determine MR configuration (labels, reviewer, etc.)

3. **Validation Phase**:
   - Verify all required information is present
   - Validate information format and correctness
   - Check for any missing or invalid data

4. **Error Handling Phase** (if validation fails):
   - Stop process immediately
   - Provide chat feedback
   - Send system notification
   - Wait for user resolution

5. **MR Creation Phase** (only if validation passes):
   - Proceed with MR creation using validated information
   - Confirm successful MR creation

### Assignee
- **MUST**: All new MRs must have the current user set as assignee by default
- The `create-mr.mjs` script automatically sets the current GitLab user as assignee when creating MRs
- This ensures proper ownership and tracking of MRs

### Reviewer
- **Priority Order**: The reviewer selection follows this priority order:
  1. **Command-line argument** (`--reviewer=@username`): Highest priority, explicitly specified in the command
  2. **User preference** (`MR_REVIEWER` in `.env.local`): User's preferred reviewer set in environment file
  3. **Default value** (`@william.chiang`): Fallback if no other option is specified
- **Setting User Preference**: Users can set their preferred reviewer in `.env.local`:
  ```
  MR_REVIEWER=@username
  ```
  - Format: GitLab username with or without `@` prefix (e.g., `@william.chiang` or `william.chiang`)
  - Reference `.env.development` template for the format
- The `create-mr.mjs` script automatically applies the reviewer based on this priority order
- **CRITICAL**: When AI automatically executes `cr single-ticket` / `cr multiple-ticket` command or `create-mr.mjs` script (e.g., in `start-task` workflow), **DO NOT** pass `--reviewer` parameter unless the user explicitly requests it. This allows the script to automatically read from `MR_REVIEWER` environment variable or use the default value `@william.chiang`

### Title
- **MUST**: MR titles must use the associated Jira ticket title
- **Format**: `{type}({ticket}): {jiraTitle}`
  - `{type}`: Commit type (feat, fix, update, refactor, chore, etc.)
  - `{ticket}`: Jira ticket number (e.g., FE-7838, IN-1234)
  - `{jiraTitle}`: The title/summary from the Jira ticket
- **Multiple tickets**: If multiple tickets are associated, use the ticket from the feature branch name as the primary ticket for the title
- **CRITICAL**: Existing MR titles **MUST NOT** be modified when updating MRs
  - The `create-mr.mjs` script will not update the title of existing MRs
  - Only new MRs will use the Jira ticket title format

### Draft Status
- **MUST**: All new MRs must be created as **Draft** by default
- Use `--no-draft` flag only when explicitly needed to create a non-draft MR
- The `create-mr.mjs` script automatically sets MRs as draft unless `--no-draft` is specified

### Target Branch
- **Default**: Target branch defaults to `main` if not specified
- **Hotfix Target Branch Automatic Setting**:
  - **MUST**: When a Jira ticket's fix version meets hotfix conditions (patch version is not 0, e.g., `5.35.1`), the system automatically:
    1. Adds the `Hotfix` label
    2. **Automatically sets the target branch to the corresponding release branch** (e.g., fix version `5.35.1` â†’ target branch `release/5.35`)
  - **Priority**: This automatic setting overrides the default value (`main`), but **does NOT override user-explicitly specified `--target` parameter**
  - **User Override**: If the user explicitly specifies a different target branch (e.g., `--target=main`), the system will prompt for confirmation because Hotfix MRs should typically be merged into `release/*` branches
  - **Examples**:
    - Jira ticket fix version: `5.35.1` â†’ Automatically sets target branch to `release/5.35`
    - Jira ticket fix version: `5.35.0` â†’ Does not trigger hotfix rule, uses default or user-specified target branch
    - Jira ticket fix version: `5.35.2` â†’ Automatically sets target branch to `release/5.35`
  - The `create-mr.mjs` script automatically implements this logic by:
    1. Checking the Jira ticket's fix version
    2. Determining if it's a hotfix (patch version â‰  0)
    3. Extracting the release branch name from the fix version (e.g., `5.35.1` â†’ `release/5.35`)
    4. Automatically updating the target branch if hotfix is detected

### Labels
- **MUST**: MRs must have appropriate UI version labels based on affected files:
  - **4.0UI**: When changes affect v4 UI only
  - **3.0UI**: When changes affect v3 UI only
  - No specific UI label: When changes affect both v3 and v4 UI

**CRITICAL**: Label determination **MUST** be based on the **comprehensive analysis of ALL change history**, not just the latest commit. This means:
- Analyze ALL commits in the MR (from base branch to HEAD)
- Consider the **final cumulative result** of all file changes
- If a file was added then deleted, it should NOT affect the label
- The label should reflect the **net effect** of all changes combined

The `create-mr.mjs` script automatically analyzes changed files and adds the appropriate labels:
- Files with `.v4.` or `/v4/` in path â†’ `4.0UI`
- Files with `.v3.` or `/v3/` in path â†’ `3.0UI`
- Files in `src/shared/` or `src/utilities/` â†’ Both versions (no specific label)
- Files with `SystemLayout.International` or `isV4()` â†’ `4.0UI`
- Files with `SystemLayout.Asia` or `isV3()` â†’ `3.0UI`

### Additional Labels
- **FE Board**: Automatically added when Jira ticket starts with `FE-`
- **Static File**: Must be added when changes only include static resource adjustments (files in `assets/` folder)
- **Vendor Customization**: Must be added when changes only modify specific existing vendor parameters

### MR Creation Success Notification

**CRITICAL**: After an MR is successfully created, **MUST** provide a comprehensive execution result report to the user in the chat.

**Required Information**:
1. **Commit Information**: Type, Ticket (with hyperlink), Message, Commit Hash
2. **Merge Request Information**: MR Link (with hyperlink), MR ID, Title, Status, Reviewer, Labels, Associated Jira (with hyperlink), AI Review status
3. **Changed Content**: List of added, updated, and reverted files with brief descriptions

**Format Reference**: Follow the standardized format defined in [mr-execution-result-report.mdc](mdc:.cursor/rules/cr/mr-execution-result-report.mdc)

**Key Requirements**:
- All Jira ticket links must be clickable hyperlinks: `[TICKET](https://innotech.atlassian.net/browse/TICKET)`
- All MR links must be clickable hyperlinks: `[MR !ID](URL)`
- Report language must match user's preferred language (Chinese or English)
- Report must be provided immediately after successful MR creation

### Agent Version Information in MR Description

**ğŸš¨ CRITICAL**: ç•¶ AI åŸ·è¡Œ `create-mr` æ™‚ï¼Œ**å‹™å¿…æ‰¾åˆ° Agent çš„ç‰ˆæœ¬è³‡è¨Šï¼Œå°‡æ‰€æœ‰ agent ç‰ˆæœ¬æä¾›çµ¦ create-mr è…³æœ¬æ·»åŠ åˆ° MR**ã€‚

#### ç‰ˆæœ¬è³‡è¨Šè¦æ±‚

1. **MR Description åº•éƒ¨é¡¯ç¤º**ï¼šAgent ç‰ˆæœ¬è³‡è¨Š**å¿…é ˆ**é¡¯ç¤ºåœ¨ MR description çš„æœ€ä¸‹æ–¹
2. **åƒæ•¸æ§åˆ¶**ï¼šç‰ˆæœ¬è³‡è¨Šé€é `--agent-version` åƒæ•¸å‚³å…¥ `create-mr.mjs` è…³æœ¬
3. **å¯é¸é¡¯ç¤º**ï¼šè‹¥æ²’æœ‰å‚³å…¥ `--agent-version` åƒæ•¸ï¼Œå‰‡ä¸é¡¯ç¤ºç‰ˆæœ¬è³‡è¨Šå€å¡Š

#### ç‰ˆæœ¬è³‡è¨Šæª”æ¡ˆå®šä½è¦å‰‡

**CRITICAL**: AI **å¿…é ˆ**æŒ‰ç…§ä»¥ä¸‹å„ªå…ˆé †åºæ‰¾åˆ°æ­£ç¢ºçš„ `version.json` æª”æ¡ˆï¼š

| å„ªå…ˆç´š | æª”æ¡ˆè·¯å¾‘ | èªªæ˜ |
|---|---|---|
| 1 | `.pantheon/version.json` | Pantheon ä»¥ submodule å½¢å¼æ›è¼‰åˆ°ç›®æ¨™å°ˆæ¡ˆæ™‚çš„ä½ç½® |
| 2 | `version.json`ï¼ˆæ ¹ç›®éŒ„ï¼‰ | Pantheon å°ˆæ¡ˆæœ¬èº«çš„ä½ç½®ï¼ˆæ ¹ç›®éŒ„ï¼‰ |
| 3 | `.cursor/version.json` | Pantheon å°ˆæ¡ˆçš„å‚™ç”¨ä½ç½® |
| 4 | å°ˆæ¡ˆå…§æœå°‹ | è‹¥ä»¥ä¸Šéƒ½æ‰¾ä¸åˆ°ï¼Œæœå°‹å°ˆæ¡ˆå…§æ‰€æœ‰ `version.json`ï¼Œæ‰¾åˆ°åŒ…å« `pantheon` key çš„æª”æ¡ˆ |

**æœå°‹é‚è¼¯**ï¼š
```bash
# å„ªå…ˆæª¢æŸ¥ .pantheon/version.jsonï¼ˆsubmodule æ›è¼‰ï¼‰
if [ -f ".pantheon/version.json" ]; then
  VERSION_FILE=".pantheon/version.json"
# æ¬¡å„ªå…ˆæª¢æŸ¥æ ¹ç›®éŒ„ version.json
elif [ -f "version.json" ]; then
  VERSION_FILE="version.json"
# å†æª¢æŸ¥ .cursor/version.json
elif [ -f ".cursor/version.json" ]; then
  VERSION_FILE=".cursor/version.json"
# æœ€å¾Œæœå°‹å°ˆæ¡ˆå…§æ‰€æœ‰ version.json
else
  # æœå°‹åŒ…å« "pantheon" key çš„ version.json
  find . -name "version.json" -exec grep -l '"pantheon"' {} \;
fi
```

#### ç‰ˆæœ¬æª”æ¡ˆæ ¼å¼

`version.json` æª”æ¡ˆæ ¼å¼ç¯„ä¾‹ï¼š
```json
{
  "pantheon": "0.0.1"
}
```

æª”æ¡ˆå¯èƒ½åŒ…å«å¤šå€‹ç‰ˆæœ¬æ¬„ä½ï¼ŒAI æ‡‰è©²æå–**æ‰€æœ‰**ç‰ˆæœ¬è³‡è¨Šï¼š
```json
{
  "pantheon": "0.0.1",
  "rules": "1.2.0",
  "scripts": "0.5.3"
}
```

#### å‚³éç‰ˆæœ¬è³‡è¨Šçµ¦ create-mr è…³æœ¬

**åŸ·è¡Œæ–¹å¼**ï¼š
```bash
# è®€å–ç‰ˆæœ¬è³‡è¨Šä¸¦å‚³éçµ¦ create-mr
VERSION_INFO=$(cat .pantheon/version.json)
pnpm run create-mr --agent-version="$VERSION_INFO"
```

**æˆ–ä½¿ç”¨ JSON å­—ä¸²æ ¼å¼**ï¼š
```bash
pnpm run create-mr --agent-version='{"pantheon":"0.0.1"}'
```

#### MR Description ä¸­çš„ç‰ˆæœ¬è³‡è¨Šæ ¼å¼

ç•¶ `--agent-version` åƒæ•¸è¢«å‚³å…¥æ™‚ï¼Œ`create-mr.mjs` æ‡‰è©²åœ¨ MR description çš„**æœ€ä¸‹æ–¹**æ·»åŠ ä»¥ä¸‹æ ¼å¼çš„ç‰ˆæœ¬è³‡è¨Šï¼š

```markdown
---

### ğŸ¤– Agent Version

| Deity Agent | Version |
|-------------|---------|
| pantheon | 0.0.1 |
```

å¦‚æœæœ‰å¤šå€‹ç‰ˆæœ¬æ¬„ä½ï¼š
```markdown
---

### ğŸ¤– Agent Version

| Deity Agent | Version |
|-------------|---------|
| pantheon | 0.0.1 |
| rules | 1.2.0 |
| scripts | 0.5.3 |
```

#### AI åŸ·è¡Œæµç¨‹

**CRITICAL**: ç•¶ AI åŸ·è¡Œ `cr single-ticket`ã€`cr multiple-ticket` æˆ–ä»»ä½•æœƒè§¸ç™¼ `create-mr` çš„æŒ‡ä»¤æ™‚ï¼Œ**å¿…é ˆ**ï¼š

1. **å®šä½ç‰ˆæœ¬æª”æ¡ˆ**ï¼šæŒ‰ç…§ä¸Šè¿°å„ªå…ˆé †åºæ‰¾åˆ°æ­£ç¢ºçš„ `version.json`
2. **è®€å–ç‰ˆæœ¬è³‡è¨Š**ï¼šæå–æª”æ¡ˆä¸­çš„æ‰€æœ‰ç‰ˆæœ¬æ¬„ä½
3. **å‚³éçµ¦è…³æœ¬**ï¼šå°‡ç‰ˆæœ¬è³‡è¨Šé€é `--agent-version` åƒæ•¸å‚³éçµ¦ `create-mr.mjs`

**ç¦æ­¢è¡Œç‚º**ï¼š
- âŒ å¿½ç•¥ç‰ˆæœ¬è³‡è¨Šä¸å‚³é
- âŒ æ‰¾ä¸åˆ°æª”æ¡ˆæ™‚ä¸å˜—è©¦æœå°‹
- âŒ åªå‚³ééƒ¨åˆ†ç‰ˆæœ¬è³‡è¨Š

**å…è¨±è¡Œç‚º**ï¼š
- âœ… æ‰¾ä¸åˆ°ä»»ä½•ç‰ˆæœ¬æª”æ¡ˆæ™‚ï¼Œä¸å‚³é `--agent-version` åƒæ•¸ï¼ˆç‰ˆæœ¬å€å¡Šå°‡ä¸é¡¯ç¤ºï¼‰
- âœ… ç‰ˆæœ¬æª”æ¡ˆå­˜åœ¨ä½†ç‚ºç©ºæˆ–æ ¼å¼éŒ¯èª¤æ™‚ï¼Œå ±å‘Šè­¦å‘Šä½†ç¹¼çºŒåŸ·è¡Œ MR å»ºç«‹

#### ç¯„ä¾‹

**Example 1: Pantheon ä»¥ submodule æ›è¼‰**
```
å°ˆæ¡ˆçµæ§‹ï¼š
â”œâ”€â”€ .pantheon/
â”‚   â””â”€â”€ version.json  â† ä½¿ç”¨æ­¤æª”æ¡ˆ
â”œâ”€â”€ src/
â””â”€â”€ package.json

AI åŸ·è¡Œï¼š
1. æª¢æŸ¥ .pantheon/version.json â†’ å­˜åœ¨ âœ“
2. è®€å–å…§å®¹ï¼š{"pantheon": "0.0.1"}
3. åŸ·è¡Œï¼špnpm run create-mr --agent-version='{"pantheon":"0.0.1"}'
```

**Example 2: åœ¨ Pantheon å°ˆæ¡ˆæœ¬èº«**
```
å°ˆæ¡ˆçµæ§‹ï¼š
â”œâ”€â”€ .cursor/
â”‚   â””â”€â”€ rules/
â”œâ”€â”€ version.json      â† ä½¿ç”¨æ­¤æª”æ¡ˆï¼ˆæ ¹ç›®éŒ„å„ªå…ˆï¼‰
â””â”€â”€ README.md

AI åŸ·è¡Œï¼š
1. æª¢æŸ¥ .pantheon/version.json â†’ ä¸å­˜åœ¨
2. æª¢æŸ¥ version.jsonï¼ˆæ ¹ç›®éŒ„ï¼‰â†’ å­˜åœ¨ âœ“
3. è®€å–å…§å®¹ï¼š{"pantheon": "0.0.1"}
4. åŸ·è¡Œï¼špnpm run create-mr --agent-version='{"pantheon":"0.0.1"}'
```

**Example 3: ç‰ˆæœ¬æª”æ¡ˆåœ¨å…¶ä»–ä½ç½®**
```
å°ˆæ¡ˆçµæ§‹ï¼š
â”œâ”€â”€ config/
â”‚   â””â”€â”€ version.json  â† åŒ…å« "pantheon" key
â”œâ”€â”€ src/
â””â”€â”€ package.json

AI åŸ·è¡Œï¼š
1. æª¢æŸ¥ .pantheon/version.json â†’ ä¸å­˜åœ¨
2. æª¢æŸ¥ .cursor/version.json â†’ ä¸å­˜åœ¨
3. æœå°‹æ‰€æœ‰ version.json â†’ æ‰¾åˆ° config/version.json
4. æª¢æŸ¥æ˜¯å¦åŒ…å« "pantheon" key â†’ æ˜¯ âœ“
5. è®€å–å…§å®¹ä¸¦å‚³éçµ¦ create-mr
```

## Pre-MR Rebase Requirement

### **CRITICAL**: Rebase to Target Branch Before Creating MR

**MUST**: Before creating any MR, feature branches **MUST** be rebased to the target branch (not the original base branch) to ensure the latest changes from the target branch are integrated.

**é‡è¦è®Šæ›´**ï¼šRebase æ™‚æ©Ÿå¾ã€Œcommit å‰ã€æ”¹ç‚ºã€Œå»ºç«‹ MR å‰ã€ï¼Œé€™æ¨£å¯ä»¥ï¼š
1. é¿å…é–‹ç™¼éç¨‹ä¸­é »ç¹ rebase é€ æˆçš„å›°æ“¾
2. ç¢ºä¿åœ¨æœ€çµ‚å»ºç«‹ MR æ™‚ï¼Œåˆ†æ”¯å·²ç¶“æ˜¯æœ€æ–°çš„
3. ç”± `create-mr.mjs` è…³æœ¬è‡ªå‹•åŸ·è¡Œï¼Œæ¸›å°‘äººç‚ºéºæ¼

### Pre-MR Validation Requirements

åœ¨å»ºç«‹ MR ä¹‹å‰ï¼Œ`create-mr.mjs` è…³æœ¬æœƒè‡ªå‹•æª¢æŸ¥ä»¥ä¸‹æ¢ä»¶ï¼š

1. **æ‰€æœ‰è®Šæ›´éƒ½å·² commit**ï¼šä¸å…è¨±æœ‰æœªæäº¤çš„è®Šæ›´
2. **å·² rebase åˆ° target branch**ï¼šç¢ºä¿åˆ†æ”¯åŒ…å«ç›®æ¨™åˆ†æ”¯çš„æœ€æ–°å…§å®¹
3. **æ‰€æœ‰ commits éƒ½å·²æ¨é€åˆ°é ç«¯**ï¼šrebase å¾Œæœƒè‡ªå‹•ä½¿ç”¨ `--force-with-lease` æ¨é€

åªæœ‰ç•¶ä¸Šè¿°ä¸‰å€‹æ¢ä»¶éƒ½æ»¿è¶³å¾Œï¼Œæ‰æœƒç¹¼çºŒåŸ·è¡Œ MR å»ºç«‹æµç¨‹ï¼ˆæ·»åŠ  labelã€é€å¯©ç­‰ï¼‰ã€‚

### Rebase Process (Automated by create-mr.mjs)

`create-mr.mjs` è…³æœ¬æœƒè‡ªå‹•åŸ·è¡Œä»¥ä¸‹æµç¨‹ï¼š

1. **æª¢æŸ¥æœªæäº¤çš„è®Šæ›´**ï¼š
   - å¦‚æœæœ‰æœªæäº¤çš„è®Šæ›´ï¼Œç«‹å³åœæ­¢ä¸¦è¦æ±‚ç”¨æˆ¶å…ˆ commit

2. **æª¢æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ rebase**ï¼š
   - å¦‚æœæœ‰æœªå®Œæˆçš„ rebaseï¼Œç«‹å³åœæ­¢ä¸¦è¦æ±‚ç”¨æˆ¶å…ˆè™•ç†

3. **åŸ·è¡Œ rebase åˆ°ç›®æ¨™åˆ†æ”¯**ï¼š
   ```bash
   git fetch origin {targetBranch}
   git rebase origin/{targetBranch}
   ```
   Where `{targetBranch}` is the target branch specified by `--target` parameter (default: `main`)

4. **è™•ç† rebase çµæœ**ï¼š
   - å¦‚æœæˆåŠŸï¼Œç¹¼çºŒä¸‹ä¸€æ­¥
   - å¦‚æœç™¼ç”Ÿè¡çªï¼Œç«‹å³åœæ­¢ä¸¦è¦æ±‚ç”¨æˆ¶æ‰‹å‹•è§£æ±º

5. **æ¨é€åˆ°é ç«¯**ï¼š
   - å¦‚æœ rebase æ”¹è®Šäº† commit historyï¼Œä½¿ç”¨ `--force-with-lease` æ¨é€
   - å¦‚æœæ˜¯ fast-forwardï¼Œä½¿ç”¨æ™®é€š push

### Conflict Resolution Process

**If conflicts occur during rebase:**

1. **è…³æœ¬æœƒç«‹å³åœæ­¢ä¸¦é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯**
2. **ç”¨æˆ¶éœ€è¦æ‰‹å‹•è§£æ±ºè¡çª**ï¼š
   ```bash
   # æª¢æŸ¥è¡çªæª”æ¡ˆ
   git status
   
   # è§£æ±ºæ¯å€‹è¡çªæª”æ¡ˆå¾Œ
   git add <æª”æ¡ˆ>
   
   # ç¹¼çºŒ rebase
   git rebase --continue
   
   # æˆ–ä¸­æ­¢ rebase
   git rebase --abort
   ```
3. **è§£æ±ºè¡çªå¾Œé‡æ–°åŸ·è¡Œ `create-mr`**

### Examples

**Example 1: Feature branch targeting main**
```
Branch: feature/IN-1234
Target branch: main (default)

Process (automated by create-mr.mjs):
1. Check uncommitted changes â†’ None âœ“
2. Check ongoing rebase â†’ None âœ“
3. git fetch origin main
4. git rebase origin/main â†’ Success âœ“
5. git push origin feature/IN-1234 --force-with-lease â†’ Success âœ“
6. Create MR with labels, reviewer, etc.
```

**Example 2: Hotfix targeting release branch**
```
Branch: feature/IN-4567
Target branch: release/5.35 (auto-detected from Jira fix version)

Process (automated by create-mr.mjs):
1. Check uncommitted changes â†’ None âœ“
2. Check ongoing rebase â†’ None âœ“
3. git fetch origin release/5.35
4. git rebase origin/release/5.35 â†’ Conflict!
5. Script stops with error message
6. User resolves conflict manually
7. User re-runs: pnpm run create-mr
8. Rebase succeeds â†’ Continue with MR creation
```

### Integration with MR Workflows

This rebase requirement is **automatically enforced** by `create-mr.mjs` for all MR-related commands:
- `cr single-ticket` command
- `cr multiple-ticket` command
- Direct `pnpm run create-mr` execution

**Execution order in create-mr.mjs:**
1. Check uncommitted changes
2. Check remote branch exists
3. **Check ongoing rebase** (new)
4. **Rebase to target branch** (new)
5. Push to remote (with `--force-with-lease` if needed)
6. Validate Jira ticket
7. Create/Update MR with labels, reviewer, etc.
8. Submit AI review (if applicable)

## Usage

### Creating Commits
Use the `agent-commit` script to ensure compliance:
```bash
pnpm run agent-commit --type=feat --ticket=FE-7838 --message="enable new sport baseball"
```

**Note**: Rebase is no longer required before commit. It will be automatically executed when creating MR.

### Creating MRs
Use the `create-mr` script which automatically:
- **Rebases to target branch** (new)
- **Pushes with `--force-with-lease` if needed** (new)
- Sets MR as draft
- Analyzes files and adds appropriate UI labels
- Adds FE Board label if applicable

```bash
pnpm run create-mr --reviewer="@william.chiang"
```

## Enforcement

- Commit message validation is enforced by:
  - `commitlint` via husky `commit-msg` hook
  - Custom rules: `subject-english-only` and `body-english-only`
  
- MR draft status and labels are enforced by:
  - `create-mr.mjs` script default behavior
  - Automatic file analysis for UI version detection

## Rule Change Compliance Check

**CRITICAL**: Whenever this rule file (`.cursor/rules/cr/commit-and-mr-guidelines.mdc`) is modified, **MUST** check and update all related implementation scripts and command files to ensure they comply with the updated rules.

### Required Actions After Rule Changes

When any changes are made to this rule file, the following actions **MUST** be performed:

1. **Identify Related Files**:
   - All commit-related command files in `.cursor/commands/`:
     - `cr/single-ticket.md`
     - `cr/multiple-ticket.md`
     - `commit-and-push.md`
     - `auto-commit-and-mr.md`
   - All commit-related scripts in `scripts/`:
     - `agent-commit.mjs`
     - `create-mr.mjs`
     - `auto-commit-and-mr.mjs`

2. **Review Each File**:
   - Check if the implementation matches the updated rules
   - Verify that all required steps are documented and implemented
   - Ensure error handling follows the specified protocols
   - Confirm that validation checks are in place

3. **Update Implementation**:
   - Update command files to reflect new requirements
   - Modify scripts to implement new validation or workflow steps
   - Add missing error handling or user feedback mechanisms
   - Ensure consistency across all related files

4. **Document Changes**:
   - Update command documentation to reflect rule changes
   - Add examples if new workflows are introduced
   - Update error messages to match new requirements

### Key Areas to Check

When reviewing related files, pay special attention to:

1. **Pre-MR Rebase Requirement**:
   - Verify that rebase is executed automatically by `create-mr.mjs` before MR creation
   - Ensure rebase targets the MR target branch (not the original base branch)
   - Check conflict resolution handling (script should stop and require manual resolution)
   - Verify `--force-with-lease` is used for pushing after rebase

2. **Information Validation Before MR Creation**:
   - Verify that all required information is validated before MR creation
   - Ensure error handling provides chat feedback and system notifications
   - Check that the process stops when information is missing

3. **Code Modification Restrictions**:
   - Verify that AI behavior follows the consent protocol
   - Ensure no automatic code modifications without user consent
   - Check that user feedback is provided for detected issues

4. **Execution Order in create-mr.mjs**:
   - Verify that the execution order matches the specified workflow:
     1. Check uncommitted changes (must be all committed)
     2. Check remote branch exists
     3. Check ongoing rebase (must be none)
     4. Rebase to target branch
     5. Push to remote (with `--force-with-lease` if needed)
     6. Validate Jira ticket
     7. Create/Update MR with labels, reviewer, etc.
     8. Submit AI review (if applicable)

### Compliance Checklist

After making rule changes, use this checklist:

- [ ] All command files (`.cursor/commands/*.md`) reviewed and updated
- [ ] All scripts (`scripts/*.mjs`) reviewed and updated
- [ ] Execution order matches the specified workflow
- [ ] Error handling follows the specified protocols
- [ ] User feedback mechanisms are in place
- [ ] Validation checks are implemented
- [ ] Examples and documentation are updated
- [ ] All changes are tested and verified
