---
alwaysApply: true
---

# Commit and MR Guidelines

This rule defines the requirements for commit messages and merge requests in this project.

## Commit Message Requirements

### Language
- **MUST**: All commits must be written in **English only**
- Commit messages (both subject and body) must be in **English only**
- Chinese characters are not allowed in commit messages
- This is enforced by commitlint rules: `subject-english-only` and `body-english-only`

### Format
Commit messages must follow the conventional commit format:
```
{type}({scope}): {subject}

{body}
```

Where:
- **type**: Must be one of: `feat`, `fix`, `update`, `refactor`, `chore`, `test`, `style`, `revert`
- **scope**: Must be a valid Jira ticket (e.g., `FE-7838`, `IN-1234`)
- **subject**: 
  - Must be lowercase
  - Maximum 64 characters
  - Must be in English only
  - **MUST** accurately describe the purpose of the current changes (必須準確描述當前改動的目的)
- **body**: Optional, but if provided must be in English only

### Examples

✅ **Correct:**
```
feat(FE-7838): enable new sport baseball in stg, dev, and demo environments
```

```
fix(IN-1234): resolve memory leak in sport game component

- Fixed memory leak in component cleanup
- Added proper event listener removal
```

❌ **Incorrect:**
```
feat(FE-7838): 啟用新的棒球運動功能  // Chinese characters not allowed
```

```
fix(IN-1234): Fix memory leak  // Uppercase not allowed in subject
```

### Code Modification Restrictions During Commit Process

**CRITICAL**: During the commit process, if any issues are detected that require code modifications, **MUST** follow the strict protocol below. **NEVER** modify code and commit/push without explicit user consent.

**重要**：此規則必須與 [ai-decision-making-priorities.mdc](mdc:.cursor/rules/ai-decision-making-priorities.mdc) 規則一起遵守。當需要修改代碼時，必須遵循「先詢問再修改」的最高優先級原則，無論任務目標為何。

#### Required Protocol

**MUST**: When any of the following situations are detected during the commit process:

1. **Code quality issues** (linting errors, code smells, architectural violations)
2. **Missing dependencies or imports**
3. **Type errors or compilation issues**
4. **Test failures**
5. **Rule violations** (Cursor rules, project conventions)
6. **Any other issues requiring code changes**

**The following protocol MUST be followed:**

1. **Immediately stop the commit process**
2. **Provide clear feedback in chat**:
   - Identify the specific issues detected
   - Explain what needs to be modified and why
   - Provide actionable guidance on how to fix the issues
   - List the specific files and locations that need modification

3. **Ask for user consent**:
   - **MUST** explicitly ask: "是否需要我協助修正這些問題？"
   - **MUST** wait for user's explicit response before proceeding
   - **MUST NOT** assume user wants automatic fixes

4. **Wait for user response**:
   - If user says **"是"**, **"可以"**, **"幫我修正"**, or similar affirmative responses → Proceed with modifications
   - If user says **"否"**, **"不用"**, **"我自己來"**, or similar negative responses → Stop and let user handle it
   - If user does not respond → **DO NOT** proceed with modifications

5. **After modifications (only if user consented)**:
   - Show what was modified
   - Ask for user confirmation before committing
   - Only proceed with commit and push after user confirms

#### Prohibited Actions

**STRICTLY FORBIDDEN**: The following actions are **NEVER** allowed without explicit user consent:

- ❌ Automatically fixing code issues and committing
- ❌ Modifying code and pushing to remote without asking
- ❌ Assuming user wants fixes based on context
- ❌ Proceeding with commit after making silent modifications
- ❌ Skipping the consent step for "obvious" fixes

#### Examples

**Example 1: Linting Errors Detected**
```
Situation: ESLint errors found in src/components/Button.tsx

Action:
1. Stop commit process
2. Notify user in chat:
   "檢測到以下 ESLint 錯誤需要修正：
   - src/components/Button.tsx:5:10 - 'unusedVariable' is assigned but never used
   - src/components/Button.tsx:12:3 - Missing return type annotation
   
   是否需要我協助修正這些問題？"

3. Wait for user response
4. If user says "是" → Fix issues → Show changes → Ask for confirmation → Commit
5. If user says "否" → Stop and let user handle it
```

**Example 2: Missing Import**
```
Situation: Missing import detected in src/utils/helper.ts

Action:
1. Stop commit process
2. Notify user in chat:
   "檢測到 src/utils/helper.ts 中缺少必要的 import：
   - Line 15 使用了 'formatDate' 但未 import
   
   是否需要我協助添加這個 import？"

3. Wait for user response
4. Only proceed if user explicitly consents
```

**Example 3: Rule Violation**
```
Situation: Cursor rule violation detected (e.g., Provider performing API calls)

Action:
1. Stop commit process
2. Notify user in chat:
   "檢測到架構規則違規：
   - src/modules/user/context/UserContext.tsx 中的 Provider 組件直接執行了 API 調用
   - 根據架構規範，Provider 不應執行 side effects
   
   建議將 API 調用移至 Controller 組件。
   是否需要我協助重構這段代碼？"

3. Wait for user response
4. Only proceed if user explicitly consents
```

**Example 4: User Explicitly Requests Fix**
```
Situation: User says "幫我修正這些 lint 錯誤"

Action:
1. Proceed with fixes (user has given explicit consent)
2. Show what was modified
3. Ask: "已修正以下問題，是否要繼續 commit？"
4. Wait for confirmation before committing
```

#### Integration with Commit Workflows

This restriction applies to **all commit-related commands and workflows**, including:

- `cr single-ticket` command
- `cr multiple-ticket` command
- `commit-and-push` command
- `agent-commit` script
- Any automated commit workflow
- Pre-commit hooks and checks

**Execution order when issues are detected:**

1. Detect issues during pre-commit checks
2. **Stop commit process immediately**
3. **Report issues in chat**
4. **Ask for user consent**
5. **Wait for user response**
6. **Only if user consents**: Fix issues → Show changes → Confirm → Commit
7. **If user declines**: Stop and let user handle it

#### Exception: User-Initiated Fix Commands

**Exception**: If user explicitly requests fixes using commands like:
- "修正這些錯誤"
- "幫我修復這些問題"
- "fix these issues"

These are considered explicit consent, and fixes can proceed. However, still:
- Show what will be modified
- Confirm before committing
- Never push without user confirmation

## Merge Request Requirements

### Pre-MR Push Requirement

**CRITICAL**: Before creating any MR, all committed changes **MUST** be pushed to the remote repository.

**Validation Steps**:
1. **Check for unpushed commits**:
   ```bash
   git log origin/{branch}..HEAD
   ```
2. **If unpushed commits exist**, push them first:
   ```bash
   git push origin {branch}
   ```
3. **Only proceed with MR creation** after all commits are successfully pushed

**Error Handling**:
- If push fails (due to permission, network, or other issues), **MUST** stop the MR creation process
- Notify the user with the specific error and suggested resolution
- Wait for user to resolve the push issue before retrying

### Development Plan Ticket Validation

**CRITICAL**: Before creating an MR, if a development plan exists for the current task, **MUST** validate that the ticket number in the development plan matches the current feature branch ticket number.

**Validation Steps**:
1. **Check for existing development plan** (from start-task notes or context)
2. **Extract ticket number from feature branch name** (e.g., `feature/FE-7893` → `FE-7893`)
3. **Compare ticket numbers**:
   - If they match → Proceed with MR creation
   - If they don't match → **MUST** stop and notify the user

**Error Handling**:
- If ticket numbers mismatch, notify the user:
  ```
  開發計畫單號與當前 feature branch 單號不一致：
  - 開發計畫單號: {planTicket}
  - Feature branch 單號: {branchTicket}
  
  請確認是否需要更新開發計畫或切換到正確的分支。
  ```
- Wait for user confirmation before proceeding

### Information Validation Before MR Creation

**CRITICAL**: Before creating any MR, **ALL** required information **MUST** be successfully retrieved and validated. The MR creation process **MUST NOT** proceed if any required information is missing or cannot be obtained.

#### Required Information Checklist

The following information **MUST** be successfully retrieved before creating an MR:

1. **GitLab Information**
   - GitLab API connection status
   - Current user information (for assignee)
   - Project information
   - Branch information
   - Any other GitLab-related data required for MR creation

2. **Jira Ticket Information**
   - Jira ticket number (from branch name or commit message)
   - Jira ticket title/summary (for MR title)
   - Jira ticket status and validity
   - Fix version information (if applicable)
   - Any other Jira-related data required for MR creation

3. **MR Configuration Information**
   - Labels (UI version labels, FE Board, Static File, Vendor Customization, etc.)
   - Reviewer information (from command argument, user preference, or default)
   - Assignee information
   - Draft status preference
   - Any other MR configuration parameters

#### Error Handling and User Feedback

**MUST**: If any required information cannot be retrieved (due to network issues, user configuration problems, API errors, etc.):

1. **Immediately stop the MR creation process**
2. **Provide clear feedback in chat**:
   - Identify which specific information is missing or cannot be retrieved
   - Explain the root cause (network issue, configuration problem, etc.)
   - Provide actionable guidance on how to resolve the issue
   - List the specific steps the user needs to take to fix the problem

3. **Send system notification**:
   - Trigger a system notification to alert the user about the issue
   - Include the same information provided in the chat feedback
   - Ensure the notification is visible and actionable

4. **Wait for user resolution**:
   - Do not proceed with MR creation until all information is successfully retrieved
   - After user fixes the issue, re-validate all information before proceeding

#### Examples of Error Scenarios

**Example 1: Network Issue**
```
Error: Cannot connect to GitLab API
Action: 
- Stop MR creation
- Notify user: "無法連接到 GitLab API，請檢查網路連線"
- Send system notification
- Wait for user to resolve network issue
```

**Example 2: Missing Jira Ticket**
```
Error: Jira ticket FE-1234 not found or cannot be accessed
Action:
- Stop MR creation
- Notify user: "無法取得 Jira ticket FE-1234 的資訊，請確認：
  1. Ticket 編號是否正確
  2. 是否有權限存取該 ticket
  3. Jira API 連線是否正常"
- Send system notification
- Wait for user to resolve issue
```

**Example 3: Missing User Configuration**
```
Error: MR_REVIEWER not set in .env.local
Action:
- Stop MR creation
- Notify user: "未設定 MR_REVIEWER，請在 .env.local 中設定：
  MR_REVIEWER=@username
  或使用 --reviewer 參數指定 reviewer"
- Send system notification
- Wait for user to add configuration
```

**Example 4: Missing Label Information**
```
Error: Cannot determine UI version label from changed files
Action:
- Stop MR creation
- Notify user: "無法自動判斷 UI 版本標籤，請確認：
  1. 變更的檔案路徑是否正確
  2. 檔案是否包含 .v3. 或 .v4. 標記
  3. 是否需要手動指定標籤"
- Send system notification
- Wait for user to resolve or manually specify labels
```

#### Validation Process Flow

The MR creation process must follow this validation flow:

1. **Pre-validation Phase**:
   - Check network connectivity
   - Verify API credentials and permissions
   - Validate user configuration files

2. **Information Retrieval Phase**:
   - Retrieve GitLab information
   - Retrieve Jira ticket information
   - Determine MR configuration (labels, reviewer, etc.)

3. **Validation Phase**:
   - Verify all required information is present
   - Validate information format and correctness
   - Check for any missing or invalid data

4. **Error Handling Phase** (if validation fails):
   - Stop process immediately
   - Provide chat feedback
   - Send system notification
   - Wait for user resolution

5. **MR Creation Phase** (only if validation passes):
   - Proceed with MR creation using validated information
   - Confirm successful MR creation

### Assignee
- **MUST**: All new MRs must have the current user set as assignee by default
- The `create-mr.mjs` script automatically sets the current GitLab user as assignee when creating MRs
- This ensures proper ownership and tracking of MRs

### Reviewer
- **Priority Order**: The reviewer selection follows this priority order:
  1. **Command-line argument** (`--reviewer=@username`): Highest priority, explicitly specified in the command
  2. **User preference** (`MR_REVIEWER` in `.env.local`): User's preferred reviewer set in environment file
  3. **Default value** (`@william.chiang`): Fallback if no other option is specified
- **Setting User Preference**: Users can set their preferred reviewer in `.env.local`:
  ```
  MR_REVIEWER=@username
  ```
  - Format: GitLab username with or without `@` prefix (e.g., `@william.chiang` or `william.chiang`)
  - Reference `.env.development` template for the format
- The `create-mr.mjs` script automatically applies the reviewer based on this priority order
- **CRITICAL**: When AI automatically executes `cr single-ticket` / `cr multiple-ticket` command or `create-mr.mjs` script (e.g., in `start-task` workflow), **DO NOT** pass `--reviewer` parameter unless the user explicitly requests it. This allows the script to automatically read from `MR_REVIEWER` environment variable or use the default value `@william.chiang`

### Title
- **MUST**: MR titles must use the associated Jira ticket title
- **Format**: `{type}({ticket}): {jiraTitle}`
  - `{type}`: Commit type (feat, fix, update, refactor, chore, etc.)
  - `{ticket}`: Jira ticket number (e.g., FE-7838, IN-1234)
  - `{jiraTitle}`: The title/summary from the Jira ticket
- **Multiple tickets**: If multiple tickets are associated, use the ticket from the feature branch name as the primary ticket for the title
- **CRITICAL**: Existing MR titles **MUST NOT** be modified when updating MRs
  - The `create-mr.mjs` script will not update the title of existing MRs
  - Only new MRs will use the Jira ticket title format

### Draft Status
- **MUST**: All new MRs must be created as **Draft** by default
- Use `--no-draft` flag only when explicitly needed to create a non-draft MR
- The `create-mr.mjs` script automatically sets MRs as draft unless `--no-draft` is specified

### Target Branch
- **Default**: Target branch defaults to `main` if not specified
- **Hotfix Target Branch Automatic Setting**:
  - **MUST**: When a Jira ticket's fix version meets hotfix conditions (patch version is not 0, e.g., `5.35.1`), the system automatically:
    1. Adds the `Hotfix` label
    2. **Automatically sets the target branch to the corresponding release branch** (e.g., fix version `5.35.1` → target branch `release/5.35`)
  - **Priority**: This automatic setting overrides the default value (`main`), but **does NOT override user-explicitly specified `--target` parameter**
  - **User Override**: If the user explicitly specifies a different target branch (e.g., `--target=main`), the system will prompt for confirmation because Hotfix MRs should typically be merged into `release/*` branches
  - **Examples**:
    - Jira ticket fix version: `5.35.1` → Automatically sets target branch to `release/5.35`
    - Jira ticket fix version: `5.35.0` → Does not trigger hotfix rule, uses default or user-specified target branch
    - Jira ticket fix version: `5.35.2` → Automatically sets target branch to `release/5.35`
  - The `create-mr.mjs` script automatically implements this logic by:
    1. Checking the Jira ticket's fix version
    2. Determining if it's a hotfix (patch version ≠ 0)
    3. Extracting the release branch name from the fix version (e.g., `5.35.1` → `release/5.35`)
    4. Automatically updating the target branch if hotfix is detected

### Labels
- **MUST**: MRs must have appropriate UI version labels based on affected files:
  - **4.0UI**: When changes affect v4 UI only
  - **3.0UI**: When changes affect v3 UI only
  - No specific UI label: When changes affect both v3 and v4 UI

**CRITICAL**: Label determination **MUST** be based on the **comprehensive analysis of ALL change history**, not just the latest commit. This means:
- Analyze ALL commits in the MR (from base branch to HEAD)
- Consider the **final cumulative result** of all file changes
- If a file was added then deleted, it should NOT affect the label
- The label should reflect the **net effect** of all changes combined

The `create-mr.mjs` script automatically analyzes changed files and adds the appropriate labels:
- Files with `.v4.` or `/v4/` in path → `4.0UI`
- Files with `.v3.` or `/v3/` in path → `3.0UI`
- Files in `src/shared/` or `src/utilities/` → Both versions (no specific label)
- Files with `SystemLayout.International` or `isV4()` → `4.0UI`
- Files with `SystemLayout.Asia` or `isV3()` → `3.0UI`

### Additional Labels
- **FE Board**: Automatically added when Jira ticket starts with `FE-`
- **Static File**: Must be added when changes only include static resource adjustments (files in `assets/` folder)
- **Vendor Customization**: Must be added when changes only modify specific existing vendor parameters

### MR Creation Success Notification

**CRITICAL**: After an MR is successfully created, **MUST** provide a comprehensive execution result report to the user in the chat.

**Required Information**:
1. **Commit Information**: Type, Ticket (with hyperlink), Message, Commit Hash
2. **Merge Request Information**: MR Link (with hyperlink), MR ID, Title, Status, Reviewer, Labels, Associated Jira (with hyperlink), AI Review status
3. **Changed Content**: List of added, updated, and reverted files with brief descriptions

**Format Reference**: Follow the standardized format defined in [mr-execution-result-report.mdc](mdc:.cursor/rules/cr/mr-execution-result-report.mdc)

**Key Requirements**:
- All Jira ticket links must be clickable hyperlinks: `[TICKET](https://innotech.atlassian.net/browse/TICKET)`
- All MR links must be clickable hyperlinks: `[MR !ID](URL)`
- Report language must match user's preferred language (Chinese or English)
- Report must be provided immediately after successful MR creation

## Pre-MR Rebase Requirement

### **CRITICAL**: Rebase to Target Branch Before Creating MR

**MUST**: Before creating any MR, feature branches **MUST** be rebased to the target branch (not the original base branch) to ensure the latest changes from the target branch are integrated.

**重要變更**：Rebase 時機從「commit 前」改為「建立 MR 前」，這樣可以：
1. 避免開發過程中頻繁 rebase 造成的困擾
2. 確保在最終建立 MR 時，分支已經是最新的
3. 由 `create-mr.mjs` 腳本自動執行，減少人為遺漏

### Pre-MR Validation Requirements

在建立 MR 之前，`create-mr.mjs` 腳本會自動檢查以下條件：

1. **所有變更都已 commit**：不允許有未提交的變更
2. **已 rebase 到 target branch**：確保分支包含目標分支的最新內容
3. **所有 commits 都已推送到遠端**：rebase 後會自動使用 `--force-with-lease` 推送

只有當上述三個條件都滿足後，才會繼續執行 MR 建立流程（添加 label、送審等）。

### Rebase Process (Automated by create-mr.mjs)

`create-mr.mjs` 腳本會自動執行以下流程：

1. **檢查未提交的變更**：
   - 如果有未提交的變更，立即停止並要求用戶先 commit

2. **檢查是否有未完成的 rebase**：
   - 如果有未完成的 rebase，立即停止並要求用戶先處理

3. **執行 rebase 到目標分支**：
   ```bash
   git fetch origin {targetBranch}
   git rebase origin/{targetBranch}
   ```
   Where `{targetBranch}` is the target branch specified by `--target` parameter (default: `main`)

4. **處理 rebase 結果**：
   - 如果成功，繼續下一步
   - 如果發生衝突，立即停止並要求用戶手動解決

5. **推送到遠端**：
   - 如果 rebase 改變了 commit history，使用 `--force-with-lease` 推送
   - 如果是 fast-forward，使用普通 push

### Conflict Resolution Process

**If conflicts occur during rebase:**

1. **腳本會立即停止並顯示錯誤信息**
2. **用戶需要手動解決衝突**：
   ```bash
   # 檢查衝突檔案
   git status
   
   # 解決每個衝突檔案後
   git add <檔案>
   
   # 繼續 rebase
   git rebase --continue
   
   # 或中止 rebase
   git rebase --abort
   ```
3. **解決衝突後重新執行 `create-mr`**

### Examples

**Example 1: Feature branch targeting main**
```
Branch: feature/IN-1234
Target branch: main (default)

Process (automated by create-mr.mjs):
1. Check uncommitted changes → None ✓
2. Check ongoing rebase → None ✓
3. git fetch origin main
4. git rebase origin/main → Success ✓
5. git push origin feature/IN-1234 --force-with-lease → Success ✓
6. Create MR with labels, reviewer, etc.
```

**Example 2: Hotfix targeting release branch**
```
Branch: feature/IN-4567
Target branch: release/5.35 (auto-detected from Jira fix version)

Process (automated by create-mr.mjs):
1. Check uncommitted changes → None ✓
2. Check ongoing rebase → None ✓
3. git fetch origin release/5.35
4. git rebase origin/release/5.35 → Conflict!
5. Script stops with error message
6. User resolves conflict manually
7. User re-runs: pnpm run create-mr
8. Rebase succeeds → Continue with MR creation
```

### Integration with MR Workflows

This rebase requirement is **automatically enforced** by `create-mr.mjs` for all MR-related commands:
- `cr single-ticket` command
- `cr multiple-ticket` command
- Direct `pnpm run create-mr` execution

**Execution order in create-mr.mjs:**
1. Check uncommitted changes
2. Check remote branch exists
3. **Check ongoing rebase** (new)
4. **Rebase to target branch** (new)
5. Push to remote (with `--force-with-lease` if needed)
6. Validate Jira ticket
7. Create/Update MR with labels, reviewer, etc.
8. Submit AI review (if applicable)

## Usage

### Creating Commits
Use the `agent-commit` script to ensure compliance:
```bash
pnpm run agent-commit --type=feat --ticket=FE-7838 --message="enable new sport baseball"
```

**Note**: Rebase is no longer required before commit. It will be automatically executed when creating MR.

### Creating MRs
Use the `create-mr` script which automatically:
- **Rebases to target branch** (new)
- **Pushes with `--force-with-lease` if needed** (new)
- Sets MR as draft
- Analyzes files and adds appropriate UI labels
- Adds FE Board label if applicable

```bash
pnpm run create-mr --reviewer="@william.chiang"
```

## Enforcement

- Commit message validation is enforced by:
  - `commitlint` via husky `commit-msg` hook
  - Custom rules: `subject-english-only` and `body-english-only`
  
- MR draft status and labels are enforced by:
  - `create-mr.mjs` script default behavior
  - Automatic file analysis for UI version detection

## Rule Change Compliance Check

**CRITICAL**: Whenever this rule file (`.cursor/rules/cr/commit-and-mr-guidelines.mdc`) is modified, **MUST** check and update all related implementation scripts and command files to ensure they comply with the updated rules.

### Required Actions After Rule Changes

When any changes are made to this rule file, the following actions **MUST** be performed:

1. **Identify Related Files**:
   - All commit-related command files in `.cursor/commands/`:
     - `cr/single-ticket.md`
     - `cr/multiple-ticket.md`
     - `commit-and-push.md`
     - `auto-commit-and-mr.md`
   - All commit-related scripts in `scripts/`:
     - `agent-commit.mjs`
     - `create-mr.mjs`
     - `auto-commit-and-mr.mjs`

2. **Review Each File**:
   - Check if the implementation matches the updated rules
   - Verify that all required steps are documented and implemented
   - Ensure error handling follows the specified protocols
   - Confirm that validation checks are in place

3. **Update Implementation**:
   - Update command files to reflect new requirements
   - Modify scripts to implement new validation or workflow steps
   - Add missing error handling or user feedback mechanisms
   - Ensure consistency across all related files

4. **Document Changes**:
   - Update command documentation to reflect rule changes
   - Add examples if new workflows are introduced
   - Update error messages to match new requirements

### Key Areas to Check

When reviewing related files, pay special attention to:

1. **Pre-MR Rebase Requirement**:
   - Verify that rebase is executed automatically by `create-mr.mjs` before MR creation
   - Ensure rebase targets the MR target branch (not the original base branch)
   - Check conflict resolution handling (script should stop and require manual resolution)
   - Verify `--force-with-lease` is used for pushing after rebase

2. **Information Validation Before MR Creation**:
   - Verify that all required information is validated before MR creation
   - Ensure error handling provides chat feedback and system notifications
   - Check that the process stops when information is missing

3. **Code Modification Restrictions**:
   - Verify that AI behavior follows the consent protocol
   - Ensure no automatic code modifications without user consent
   - Check that user feedback is provided for detected issues

4. **Execution Order in create-mr.mjs**:
   - Verify that the execution order matches the specified workflow:
     1. Check uncommitted changes (must be all committed)
     2. Check remote branch exists
     3. Check ongoing rebase (must be none)
     4. Rebase to target branch
     5. Push to remote (with `--force-with-lease` if needed)
     6. Validate Jira ticket
     7. Create/Update MR with labels, reviewer, etc.
     8. Submit AI review (if applicable)

### Compliance Checklist

After making rule changes, use this checklist:

- [ ] All command files (`.cursor/commands/*.md`) reviewed and updated
- [ ] All scripts (`scripts/*.mjs`) reviewed and updated
- [ ] Execution order matches the specified workflow
- [ ] Error handling follows the specified protocols
- [ ] User feedback mechanisms are in place
- [ ] Validation checks are implemented
- [ ] Examples and documentation are updated
- [ ] All changes are tested and verified
